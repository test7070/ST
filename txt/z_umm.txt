z_umm15:--z_umm15
	declare @t_bcustno nvarchar(50) = case when '#non'=[5] then '' else [5] end
	declare @t_ecustno nvarchar(50) = case when '#non'=[6] then char(255) else [6] end
	declare @t_bmon nvarchar(10) = case when '#non'=[13] then '' else [13] end
	declare @t_emon nvarchar(10) = case when '#non'=[14] then char(255) else [14] end
	----------------------------------------------------------------
--收款紀錄
declare @umms table(
	recno int,
	custno nvarchar(50),
	datea nvarchar(20),
	cno nvarchar(50),
	acc1 nvarchar(50),
	acc2 nvarchar(50),
	money float,
	chgs float,
	checkno nvarchar(50),
	account nvarchar(50),
	bank nvarchar(50),
	indate nvarchar(20),
	memo nvarchar(MAX)
)
insert @umms
select ROW_NUMBER() over (partition by a.custno,a.datea order by a.custno,a.datea,a.noa,b.noq)
,a.custno,a.datea,a.cno,b.acc1,b.acc2,b.money,b.chgs
,b.checkno,b.account,b.bank,b.indate,b.memo
from umm a left join umms b on a.noa=b.noa 
where a.custno between @t_bcustno and @t_ecustno 
and a.mon between @t_bmon and @t_emon
and (b.acc1!='' or b.money!=0 or b.chgs!=0 or b.checkno!='' or b.account!='' or b.bank!='' or b.indate!='')

--沖帳紀錄
declare @paysale table(		
	recno int,
	custno nvarchar(50),
	datea nvarchar(20),
	mon nvarchar(20),
	vccno nvarchar(100),
	paysales float,
	memo nvarchar(MAX)
)

insert @paysale
select ROW_NUMBER() over (partition by a.custno,a.datea order by a.custno,a.datea,a.noa,b.noq),
b.custno,a.datea,b.paymon,b.vccno,b.paysale,b.memo
from umm a left join umms b on a.noa=b.noa 
where a.custno between @t_bcustno and @t_ecustno 
and a.mon between @t_bmon and @t_emon
and vccno!=''

--本月應收金額
declare @custunpay table(		
	custno nvarchar(50),
	unpay float,
	total float
)

insert @custunpay
select noa,SUM(unpay),0 from cust_2s 
where noa between @t_bcustno and @t_ecustno and mon<=@t_emon
group by noa

--收款月份後沖帳的金額
declare @custopaysale table(		
	custno nvarchar(50),
	opaysale float
)

insert @custopaysale
select ub.custno,SUM(ub.paysale) opaysale from umm ua left join umms ub on ua.noa=ub.noa 
where ua.mon >= @t_bmon and ub.paymon<=@t_emon and ub.vccno!='' group by ub.custno

--本月應收金額-收款月份後沖帳的金額=本月收款月份前的應收金額
update a
set unpay=a.unpay+isnull(b.opaysale,0)
from @custunpay a left join @custopaysale b on a.custno=b.custno

update a
set total=a.unpay-isnull((select SUM(paysales) from @paysale where custno=a.custno),0)
from @custunpay a

----------------------------------------------------------
declare @tmp table(
	recno int,
	custno nvarchar(50),
	datea nvarchar(20),
	cno nvarchar(50),
	acc1 nvarchar(50),
	acc2 nvarchar(50),
	money float,
	chgs float,
	checkno nvarchar(50),
	account nvarchar(50),
	bank nvarchar(50),
	indate nvarchar(20),
	memo nvarchar(MAX),
	mon nvarchar(20),
	vccno nvarchar(100),
	paysales float
)

declare @custno nvarchar(50) 
declare cursor_table cursor for
select custno from (select custno from @umms union all select custno from @paysale) custtmp group by custno
open cursor_table
fetch next from cursor_table
into @custno
while(@@FETCH_STATUS <> -1)
begin
	if((select count(*) from @umms where custno=@custno )>=(select count(*) from @paysale where custno=@custno))
	begin
		insert @tmp
		select a.recno,a.custno,a.datea,a.cno,a.acc1,a.acc2,a.money,a.chgs,a.checkno,a.account
		,a.bank,a.indate,a.memo,b.mon,b.vccno,b.paysales
		from @umms a left join @paysale b on a.custno=b.custno and a.datea=b.datea and a.recno=b.recno 
		where a.custno=@custno
	end
	else
	begin
		insert @tmp
		select b.recno,b.custno,b.datea,a.cno,a.acc1,a.acc2,a.money,a.chgs,a.checkno,a.account
		,a.bank,a.indate,a.memo,b.mon,b.vccno,b.paysales
		from @umms a right join @paysale b on a.custno=b.custno and a.datea=b.datea and a.recno=b.recno 
		where b.custno=@custno
	end

	fetch next from cursor_table
	into @custno
end
close cursor_table
deallocate cursor_table

declare @tmpa table(
	gno nvarchar(10),
	custno nvarchar(50),
	comp nvarchar(50),
	unpay float,
	recno int,
	datea nvarchar(20),
	cno nvarchar(50),
	acomp nvarchar(50),
	acc1 nvarchar(50),
	acc2 nvarchar(50),
	money float,
	chgs float,
	checkno nvarchar(50),
	account nvarchar(50),
	bank nvarchar(50),
	indate nvarchar(20),
	memo nvarchar(MAX),
	mon nvarchar(20),
	vccno nvarchar(100),
	paysales float,
	total float
)
insert @tmpa
select '0',a.custno,case when isnull(c.nick,'')!='' then c.nick else left(c.comp,4) end
,a.unpay,b.recno,b.datea,b.cno,case when isnull(d.nick,'')!='' then d.nick else left(d.acomp,4) end
,b.acc1,b.acc2,b.money,b.chgs,b.checkno,b.account,b.bank,b.indate
,b.memo,b.mon,b.vccno,b.paysales,a.total
from @custunpay a left join @tmp b on a.custno=b.custno
left join cust c on a.custno=c.noa
left join acomp d on b.cno=d.noa

insert @tmpa
select '0',b.custno,case when isnull(c.nick,'')!='' then c.nick else left(c.comp,4) end 
,isnull(a.unpay,0),b.recno,b.datea,b.cno,case when isnull(d.nick,'')!='' then d.nick else left(d.acomp,4) end 
,b.acc1,b.acc2,b.money,b.chgs,b.checkno,b.account,b.bank,b.indate 
,b.memo,b.mon,b.vccno,b.paysales,a.total 
from @custunpay a right join @tmp b on a.custno=b.custno 
left join cust c on b.custno=c.noa 
left join acomp d on b.cno=d.noa 
where not exists (select * from @tmpa where custno=b.custno)

delete @tmpa where isnull(unpay,0)=0 and isnull(money,0)=0 and ISNULL(chgs,0)=0 and isnull(paysales,0)=0

select 
dbo.getComma(unpay,0)unpay
,dbo.getComma(money,0)money
,dbo.getComma(chgs,0)chgs
,dbo.getComma(paysales,0)paysales
,dbo.getComma(total,0)total
,* 
from @tmpa order by gno,custno,recno
;
--*******************************************************************************
z_umm14:--z_umm14
	declare @t_bdate nvarchar(10) = case when '#non'=[3] then '' else [3] end
	declare @t_edate nvarchar(10) = case when '#non'=[4] then char(255) else [4] end
	declare @t_bcustno nvarchar(50) = case when '#non'=[5] then '' else [5] end
	declare @t_ecustno nvarchar(50) = case when '#non'=[6] then char(255) else [6] end
	declare @t_bmon nvarchar(10) = case when '#non'=[13] then '' else [13] end
	declare @t_emon nvarchar(10) = case when '#non'=[14] then char(255) else [14] end
	declare @t_project nvarchar(50)=case when '#non' = '[26]' then '' else '[26]' end
	----------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(10),
		custno nvarchar(50),
		cust nvarchar(100),
		nick nvarchar(100),
		salesno nvarchar(50),
		sales nvarchar(100),
		discount float
	)
	insert into @tmp(gno,custno,discount)
	select '1',ISNULL(a.custno,''),sum(isnull(b.[money],0))
	from umm a
	left join umms b on a.noa=b.noa
	where (LEFT(b.acc1,4)=(case when @t_project='FE' then '4107' else '4106' end) or charindex(b.acc2,'銷貨折讓')>0)
	and isnull(a.datea,'') between @t_bdate and @t_edate
	and isnull(a.mon,'') between @t_bmon and @t_emon
	and ISNULL(a.custno,'') between @t_bcustno and @t_ecustno
	group by ISNULL(a.custno,'')
	
	insert into @tmp(gno,discount)
	select '2',SUM(ISNULL(discount,0))
	from @tmp
	
	update @tmp set cust=b.comp,nick=b.nick,salesno=b.salesno,sales=b.sales
	from @tmp a
	left join cust b on a.custno=b.noa
	
	select custno a01
		,replace(cust,'~#$',char(39)) a02
		,sales a03
		,dbo.getComma(discount,0) a04
		,* 
	from @tmp order by gno,custno;
--************************************************************************************************
z_umm4:--z_umm4
declare @t_accy nvarchar(20)
declare @t_bxdate nvarchar(20)
declare @t_exdate nvarchar(20)
set @t_accy = '[9]'
set @t_bxdate = case when '#non' = [7] then '' else [7] end
set @t_exdate = case when '#non' = [8] then CHAR(255) else [8] end
declare @tmp table(
	gno nvarchar(1),
	noa nvarchar(20),
	accc3 nvarchar(20),
	accc2 nvarchar(20),
	part nvarchar(20),
	accc6 nvarchar(50),
	memo nvarchar(max),
	dc nvarchar(20),
	inmoney int,
	paymoney int,
	ainmoney int,
	binmoney int,
	cinmoney int,
	apaymoney int,
	bpaymoney int,
	cpaymoney int,
	atotal int,
	btotal int,
	ctotal int,
	title nvarchar(20),
	zno nvarchar(20),
	azno nvarchar(20),
	acc1 nvarchar(20),
	partworker nvarchar(50),
	tbank nvarchar(50),
	bank2 nvarchar(50)
)
insert into @tmp
	select '0' gno,case when len(b.zno)>0 then left(a.zno,12)end,b.accc3,isnull(a.accc2,''),c.part,b.accc6,
	b.accc7,b.dc ,case when dc = '1' and b.dmoney > 0 then b.dmoney end,
	case when dc = '2' and b.cmoney > 0 then b.cmoney end ,
	case when LEFT(b.accc5,4) = '1111' and dc = 1 then b.dmoney end,
	case when left(b.accc5,4) = '1112' and dc = 1 then b.dmoney end,
	case when left(b.accc5,4) = '1121' and dc = 1 then b.dmoney end,
	case when left(b.accc5,4) = '1111' and dc = 2 then b.cmoney end,
	case when left(b.accc5,4) = '1112' and dc = 2 then b.cmoney end,
	case when left(b.accc5,4) = '2121' and dc = 2 then b.cmoney end,
	0,0,0,
	(case when @t_bxdate = @t_exdate then '日' else '月' end),b.zno,a.zno,b.accc5,c.part+'－'+a.worker ,
	case when left(accc5,4) = '1121' then d.tbank end,case when left(accc5,4) = '2121' then d.bank end
	from acccs[9] b
	left join accc[9] a on a.accc3 = b.accc3
	left join acpart[9] c on b.part = c.noa
	left join gqb d on d.gqbno = left
	(ltrim(substring
	(b.accc7,CHARINDEX(' ',b.accc7)+1,len(b.accc7))),
	CHARINDEX(' ',ltrim(substring(b.accc7,CHARINDEX(' ',b.accc7)+1,len(b.accc7))))
	)
	where (a.accc2 between @t_bxdate and @t_exdate) and (
	(left(b.accc5,4) = '1111' or left(b.accc5,4) = '1112')
	or (left(b.accc5,4) = '1121' and len(b.zno)>0 or left(b.accc5,4) = '2121' and len(b.zno)>0))


insert into @tmp
	select '1' gno,'',CHAR(255),'',part,'','','',SUM(inmoney),SUM(paymoney),sum(ainmoney),sum(binmoney),sum(cinmoney),sum(apaymoney),
	sum(bpaymoney),sum(cpaymoney),0,0,0,'','','','','','',''
	from @tmp
	group by part
insert into @tmp
	select '2' gno,'',CHAR(255),'',CHAR(255),'','','',SUM(inmoney),SUM(paymoney),sum(ainmoney),sum(binmoney),sum(cinmoney),sum(apaymoney),
	sum(bpaymoney),sum(cpaymoney),0,0,0,'','','','','','',''
	from @tmp
	where gno = 0
insert into @tmp
	select '3' gno,'',CHAR(255),'',CHAR(255),'','','',0,0,0,0,0,0,0,0,ainmoney-apaymoney,binmoney-bpaymoney,cinmoney-cpaymoney,'','','' ,'','' ,'',''
	from @tmp
	where gno = 2

select gno,noa,accc3,accc2,part,accc6,memo,dc,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,paymoney),1)),4,12)) paymoney,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ainmoney),1)),4,12)) ainmoney,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,binmoney),1)),4,12)) binmoney,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,cinmoney),1)),4,12)) cinmoney,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,apaymoney),1)),4,12)) apaymoney,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bpaymoney),1)),4,12)) bpaymoney,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,cpaymoney),1)),4,12)) cpaymoney,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,atotal),1)),4,12)) atotal,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,btotal),1)),4,12)) btotal,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ctotal),1)),4,12)) ctotal,title,zno,azno,acc1,partworker
	,tbank,bank2
from @tmp
order by part,accc3,gno;
--********************************************************************************
z_umm7:--z_umm7
declare @t_cno nvarchar(20) 
declare @t_bcustno nvarchar(50)
declare @t_ecustno nvarchar(50)
declare @t_bsmon nvarchar(10)
declare @t_esmon nvarchar(10)
declare @t_xaccy nvarchar(20)
declare @t_xpart nvarchar(20)
declare @t_xcoin nvarchar(20)
declare @t_custtype nvarchar(20)


set @t_cno = case when '#non' = [1] then '' else [1] end
set @t_xaccy = '[10]'
set @t_bcustno = case when '#non' = [5] then '' else [5] end
set @t_ecustno = case when '#non' = [6] then CHAR(255) else [6] end
set @t_bsmon = case when '#non' = [13] then '' else [13] end
set @t_esmon = case when '#non' = [14] then CHAR(255) else [14] end
set @t_xpart = case when '#non' = [2] then '' else [2] end
set @t_xcoin = case when '#non' = [27] then '' else [27] end
set @t_custtype = case when '#non' = [31] then '' else [31] end
-----------------------------------------------------------------------------------------------------------
SET QUOTED_IDENTIFIER OFF
declare @cmd nvarchar(max)
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END

declare @coin nvarchar(20)

create table #tmp(
	coin nvarchar(20),
	gno nvarchar(1),
	cno nvarchar(50),
	custno nvarchar(50),
	comp nvarchar(MAX),
	mon nvarchar(10),
	money float,
	total float,
	payed float,
	unpay float
	PRIMARY KEY (coin,gno,cno,custno,mon)
)

insert into #tmp (coin,gno,cno,custno,mon,money,total,payed)
select coin,gno,cno,custno,mon,SUM(money),SUM(total),SUM(payed) from (
	--前期
	select @t_xcoin coin,'9' gno,cno,a.noa custno,a.mon,sum(unpay*coin.floata) money,0 total,0 payed 
	from cust_2s a
	left join cust b on a.noa = b.noa
	outer apply (select case when len(@t_xcoin)=0 then 1 else isnull((select top 1 floata from flors where coin=@t_xcoin and a.mon <=edate order by edate desc,noa desc),1) end floata) coin 
	where a.mon<@t_bsmon and a.noa between @t_bcustno and @t_ecustno
	and (len(@t_cno)=0 or a.cno=@t_cno)
	and (len(@t_custtype)=0 or b.typea=@t_custtype)
	group by cno,a.noa,a.mon
	union all
	--本期
	select @t_xcoin,'9',cno,a.noa,a.mon,0,totsale*coin.floata,pay 
	from cust_2s a 
	left join cust b on a.noa = b.noa
	outer apply (select case when len(@t_xcoin)=0 then 1 else isnull((select top 1 floata from flors where coin=@t_xcoin and a.mon <=edate order by edate desc,noa desc),1) end floata) coin 
	where a.mon between @t_bsmon and @t_esmon and a.noa between @t_bcustno and @t_ecustno
	and (len(@t_cno)=0 or a.cno=@t_cno)
	and (len(@t_custtype)=0 or b.typea=@t_custtype)
)tmp group by coin,gno,cno,custno,mon

if(@t_xcoin='ALL')
begin
	declare cursor_table cursor for
	select coin from flors group by coin
	open cursor_table
	fetch next from cursor_table
	into @coin
	while(@@FETCH_STATUS <> -1)
	begin
		
		insert into #tmp (coin,gno,cno,custno,mon,money,total,payed)
		select coin,gno,cno,custno,mon,SUM(money),SUM(total),SUM(payed) from (
			--前期
			select @coin coin,'9' gno,cno,a.noa custno,a.mon,sum(unpay*coin.floata) money,0 total,0 payed 
			from cust_2s a 
			left join cust b on a.noa = b.noa
			outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.mon <=edate order by edate desc,noa desc),1) floata) coin
			where a.mon<@t_bsmon and a.noa between @t_bcustno and @t_ecustno
			and (len(@t_cno)=0 or a.cno=@t_cno)
			and (len(@t_custtype)=0 or b.typea=@t_custtype)
			group by cno,a.noa,a.mon
			union all
			--本期
			select @coin,'9',cno,a.noa,a.mon,0,totsale*coin.floata,pay 
			from cust_2s a 
			left join cust b on a.noa = b.noa
			outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.mon <=edate order by edate desc,noa desc),1) floata) coin
			where a.mon between @t_bsmon and @t_esmon and a.noa between @t_bcustno and @t_ecustno
			and (len(@t_cno)=0 or a.cno=@t_cno)
			and (len(@t_custtype)=0 or b.typea=@t_custtype)
		)tmp group by coin,gno,cno,custno,mon
		
		fetch next from cursor_table
		into @coin
	end
	close cursor_table
	deallocate cursor_table
end

if(@t_xcoin='ALL')
begin
	update #tmp set coin='' where coin=@t_xcoin
end

--加總
insert into #tmp (coin,gno,cno,mon,custno,money,total,payed)
select coin,'0',cno,mon,custno,SUM(money),SUM(total),SUM(payed) from #tmp 
group by coin,cno,custno,mon order by coin,cno,custno,mon

delete #tmp where money=0 and total=0 and payed=0

delete #tmp where gno='9'

--插入本期有的資料,最小未收月份
insert #tmp (gno,mon,custno,money,total,payed,coin,cno)
select '1',MIN(mon),custno,0,SUM(total),sum(payed),coin,cno
from #tmp where gno='0'
group by custno,coin,cno

--插入沒有本期金額最小月份的未收金額
insert #tmp (gno,mon,custno,money,total,payed,coin,cno)
select '1',MIN(mon),custno,0,0,0,coin,cno
from #tmp a 
where gno='0' and not exists (select * from #tmp where gno='1' and custno=a.custno and coin=a.coin and cno=a.cno)
group by custno,coin,cno

--更新最小未收月份金額
update a
set money=isnull((select money from #tmp where gno='0' and mon=a.mon and custno=a.custno and coin=a.coin and cno=a.cno),0)
from #tmp a where gno='1'

--插入其他未收金額
insert #tmp (gno,mon,custno,cno,coin,money,total,payed,unpay)
select '2',mon,custno,cno,coin,money,total,payed,0
from #tmp a 
where gno='0' and not exists (select * from #tmp where gno='1' and custno=a.custno and coin=a.coin and cno=a.cno and mon=a.mon)
and mon not between @t_bsmon and @t_esmon

delete #tmp where gno='0'

update a
set unpay=(select sum(isnull(money,0)+isnull(total,0)-isnull(payed,0)) from #tmp where custno=a.custno and coin=a.coin and cno=a.cno)
from #tmp a
where gno='1'

--總計
insert into #tmp (coin,gno,cno,custno,comp,mon,money,total,payed,unpay)
select coin,'3'gno,cno,char(255),'',CHAR(255),sum(money),sum(total),sum(payed),SUM(unpay) from #tmp 
group by coin,cno

update a 
set comp=isnull((select top 1 nick from (select nick from cust where noa=a.custno)tmp),'')
from #tmp a

update a 
set comp=isnull((select top 1 namea from (select namea from carOwner where noa=a.custno union select namea from sss where noa=a.custno)tmp),'')
from #tmp a where isnull(comp,'')=''

select gno,cno,isnull((select top 1 acomp from acomp where a.cno=noa),'') acomp,custno,replace(comp,'~#$',char(39)) comp,mon
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,money),1)),(case when coin!='' then 0 else 4 end),30)) money
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),(case when coin!='' then 0 else 4 end),30)) total
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,payed),1)),(case when coin!='' then 0 else 4 end),30)) payed
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unpay),1)),(case when coin!='' then 0 else 4 end),30)) unpay
	,case when coin!='' then '_'+coin else '' end coin
from #tmp a order by coin,cno,custno,gno,mon

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END
;
--********************************************************************************
z_umm6:--z_umm6
declare @t_bscno nvarchar(20)
declare @t_escno nvarchar(20)
declare @t_bcustno nvarchar(50)
declare @t_ecustno nvarchar(50)
declare @t_bsmon nvarchar(10)
declare @t_esmon nvarchar(10)
declare @t_xaccy nvarchar(20)
declare @t_xpart nvarchar(20)
set @t_xaccy = '[10]'
set @t_bscno = case when '#non' = [11] then '' else [11] end
set @t_escno = case when '#non' = [12] then CHAR(255) else [12] end
set @t_bcustno = case when '#non' = [5] then '' else [5] end
set @t_ecustno = case when '#non' = [6] then CHAR(255) else [6] end
set @t_xpart = case when '#non' = [2] then '' else [2] end
set @t_bsmon = case when '#non' = [13] then '' else [13] end
set @t_esmon = case when '#non' = [14] then CHAR(255) else [14] end
declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(50),
	ccomp nvarchar(MAX),
	cno nvarchar(20),
	acomp nvarchar(50),
	money float,
	noa nvarchar(50),
	typea nvarchar(50),
	total float,
	payed float,
	unpay float,
	partno nvarchar(20),
	part nvarchar(50)
)
insert into @tmp
	select '0'gno,a.custno,b.nick ccomp,a.cno,c.nick acomp,money,'','',total,payed,unpay,partno,part
	from(
		select custno,cno,SUM(isnull(money,0))money,SUM(isnull(total,0))total,SUM(isnull(payed,0))payed,SUM(isnull(unpay,0))unpay,partno,part from (
			--trd運輸部
			select custno,cno,isnull((select SUM(unpay) from view_trd b where a.custno=b.custno and a.cno=b.cno and mon<@t_bsmon),0) money,sum(total)total,sum(payed)payed,SUM(unpay)+isnull((select SUM(unpay) from view_trd b where a.custno=b.custno and a.cno=b.cno and mon<@t_bsmon),0) unpay,'08' partno,'運輸部' part
			from view_trd a
			where ((case when len(mon)=0 then left(datea,6) else mon end ) between @t_bsmon and @t_esmon)   group by custno,cno
			union all
			--vcc
			select custno,cno,isnull((select SUM(unpay) from view_vcc b where a.custno=b.custno and a.cno=b.cno and mon<@t_bsmon),0)
			-isnull((select sum(paysale) from umms where left(right(memo2,9),6)<@t_bsmon and vccno=a.custno),0) --如果dc有問題請將這行註解(st勿刪)
			money
			,SUM(total)total
			,sum(payed)
			+isnull((select sum(paysale) from umms where left(right(memo2,9),6) between @t_bsmon and @t_esmon and vccno=a.custno),0) --如果dc有問題請將這行註解(st勿刪)
			payed
			,SUM(unpay)+isnull((select SUM(unpay)from view_vcc b where a.custno=b.custno and a.cno=b.cno and mon<@t_bsmon),0)
			-isnull((select sum(paysale) from umms where vccno=a.custno and left(right(memo2,9),6) <= @t_esmon ),0) --如果dc有問題請將這行註解(st勿刪)
			unpay
			,partno,part
			from view_vcc a
			where ((case when len(mon)=0 then left(datea,6) else mon end ) between @t_bsmon and @t_esmon) and  (left(isnull(kind,''),4)!='健勞勞退') group by custno,cno,partno,part
			union all
			--cara 監理部
			select a.custno,a.cno,a.money,a.total,a.payed,a.unpay,'07' partno,'監理部' part from(
				select custno,cno,SUM(isnull(money,0))money,SUM(isnull(total,0))total,SUM(isnull(payed,0))payed,SUM(isnull(unpay,0))unpay from(
					select a.carownerno custno,c.cardealno cno,
					(select outmoney-inmoney from caras b where a.noa=b.noa and caritemno='001')money,
					(select sum(outmoney)  from caras b where a.noa=b.noa and caritemno!='001')total,
					(select sum(inmoney)  from caras b where a.noa=b.noa and caritemno!='001')payed,
					a.total unpay from cara a left join car2 c on a.carno=c.noa where (a.mon between @t_bsmon and @t_esmon)
				)tmp group by custno,cno
			)a
		)tmpb group by custno,cno,partno,part)a
	left join cust b on a.custno=b.noa left join acomp c on a.cno=c.noa
	where (a.cno between @t_bscno and @t_escno) and (a.custno between @t_bcustno and @t_ecustno) and (LEN(@t_xpart) = 0 or @t_xpart = partno)
	order by custno,cno

insert into @tmp
	--trd
	select '1'gno,custno,'',cno,'',null money,noa,'出車',total,payed,unpay,'08' partno,'運輸部' part from view_trd a
	where ((case when len(mon)=0 then left(datea,6) else mon end ) between @t_bsmon and @t_esmon)
	and (a.cno between @t_bscno and @t_escno) and (a.custno between @t_bcustno and @t_ecustno) and (LEN(@t_xpart) = 0 or @t_xpart = '運輸部')

insert into @tmp
	--vcc
	select '2'gno,custno,'',cno,'',null money,noa,'請款',total,payed,unpay,partno,part from view_vcc a
	where ((case when len(mon)=0 then left(datea,6) else mon end ) between @t_bsmon and @t_esmon) and  (left(isnull(kind,''),4)!='健勞勞退')
	and (a.cno between @t_bscno and @t_escno) and (a.custno between @t_bcustno and @t_ecustno)and (LEN(@t_xpart) = 0 or @t_xpart = part)

insert into @tmp
	--cara
	select '3'gno,a.carownerno,'',c.cardealno,'',
	isnull((select outmoney-inmoney from caras b where a.noa=b.noa and caritemno='001'),0)money,
	a.noa,'車主',
	isnull((select sum(outmoney)  from caras b where a.noa=b.noa and caritemno!='001'),0)total,
	isnull((select sum(inmoney)  from caras b where a.noa=b.noa and caritemno!='001'),0)payed,
	a.total unpay,'07' partno,'監理部' part
	from cara a left join car2 c on a.carno=c.noa
	where (a.mon between @t_bsmon and @t_esmon) and (c.cardealno between @t_bscno and @t_escno) and (a.carownerno between @t_bcustno and @t_ecustno)and (LEN(@t_xpart) = 0 or @t_xpart = '監理部')

insert into @tmp
	select '4'gno,CHAR(255),'',CHAR(255),'',
	SUM(money),'','',SUM(total),SUM(payed),SUM(unpay),'',''
	from @tmp where gno='0'

select gno,a.custno,replace(b.nick,' ','')+'('+replace(a.custno,' ','')+')' ccomp,a.cno,c.nick acomp,a.noa,a.typea
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,12)) money
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,payed),1)),4,12)) payed
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,unpay),1)),4,12)) unpay
	,partno,part
from @tmp a
left join cust b on a.custno=b.noa left join acomp c on a.cno=c.noa
order by custno,cno,gno;

------------------------------------------------------------------------------------------------------------------
z_umm2:--z_umm2
declare @t_cno nvarchar(20)
declare @t_part nvarchar(20)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_bcustno nvarchar(50)
declare @t_ecustno nvarchar(50)
declare @t_acckey nvarchar(MAX)

set @t_cno = case when '#non' = [1] then '' else [1] end
set @t_part = case when '#non' = [2] then '' else [2] end
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_bcustno = case when '#non' = [5] then '' else [5] end
set @t_ecustno = case when '#non' = [6] then CHAR(255) else [6] end
set @t_acckey = case when '#non' = [30] then '' else [30] end

declare @tmpa table( 
	acc2 nvarchar(100)
)
declare @t_key nvarchar(MAX) =@t_acckey

while(CHARINDEX(',',@t_key)>0)
begin
	insert @tmpa
	select replace(LEFT(@t_key,CHARINDEX(',',@t_key)-1),' ','')
	
	set @t_key=SUBSTRING(@t_key,CHARINDEX(',',@t_key)+1,LEN(@t_key))
end
insert @tmpa
select replace(@t_key,' ','')

declare @tmp table(
	gno nvarchar(1),
	noa nvarchar(30),
	noq nvarchar(20),
	datea nvarchar(10),
	cno nvarchar(20),
	acc1 nvarchar(20),
	typea nvarchar(50),
	custno nvarchar(50),
	comp nvarchar(MAX),
	[money] float,
	chgs float,
	paysales float,
	mons nvarchar(6),
	part nvarchar(10),
	vccno nvarchar(20),
	unpay float,
	checkno nvarchar(20),
	bank nvarchar(20),
	indate nvarchar(10),
	acomp nvarchar(50),
	account nvarchar(20),
	memo nvarchar(MAX)
)
insert into @tmp
	select '0' gno,b.noa,b.noq,a.datea,a.cno,b.acc1,b.acc2
	,case when c.custno2!='' then c.custno2 when c.custno!='' then c.custno else a.custno end
	,left(case when c.custno2!='' then c.comp2 when c.custno!='' then c.comp else a.comp end,4),b.money,b.chgs,b.paysale,b.mon,b.part,b.vccno,a.unpay,
	b.checkno,b.bank,b.indate,left(a.acomp,4),b.account,b.memo
from umm a
left join umms b on b.noa = a.noa
left join view_vcc c on b.vccno=c.noa
where (LEN(@t_cno) = 0 or a.cno = @t_cno) and
	(LEN(@t_part) = 0 or b.partno = @t_part) and
	(a.datea between @t_bdate and @t_edate)
	and (a.custno between @t_bcustno and @t_ecustno)
	and (len(@t_acckey)=0 or exists (select * from @tmpa where charindex(acc2,replace(b.acc2,' ',''))>0)) 

update a
set a.custno=(select MAX(custno) from @tmp where noa=a.noa)
,a.comp=(select MAX(comp) from @tmp where noa=a.noa)
from @tmp a
where custno=''

insert into @tmp
	select '1' gno,'','',datea,'','','','','',sum(money),sum(chgs),sum(paysales),'','','',sum(unpay),
	'','','','','','' m
from @tmp
group by datea

insert into @tmp
select '2' gno,'','','999/99/99','','','','','',sum(money),sum(chgs),sum(paysales),'','','',0, '','','','','','' m
from @tmp where gno='0'

insert into @tmp
select '3' gno,'','','999/99/99','','',typea,'','',sum(money),sum(chgs),sum(paysales),'','','',0, '','','','','','' m
from @tmp where gno='0' and typea!=''
group by typea

insert into @tmp
select '4' gno,'','','999/99/99','','','','','',sum(money),sum(chgs),sum(paysales),'','','',0, '','','','','','' m
from @tmp where gno='0'

select gno,noa,noq,datea,cno,acc1,custno,replace(comp,'~#$',char(39)) comp,
	case when len(typea)> 4 then REPLACE(typea,'銀行存款','') else typea end typea,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,money),1)),4,30)) money,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,chgs),1)),4,30)) chgs,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,paysales),1)),4,30)) paysales,
	mons,part,vccno,unpay,checkno,bank,indate,acomp,account,memo +(case when len(memo)>0 then '<BR>'+vccno else vccno end) memo
from @tmp
order by datea,gno,noa,noq;
--*************************************************************************************************************************************
z_umm5:--z_umm5
declare @t_cno nvarchar(20)
declare @t_part nvarchar(20)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_bcustno nvarchar(50)
declare @t_ecustno nvarchar(50)
set @t_cno = case when '#non' = [1] then '' else [1] end
set @t_part = case when '#non' = [2] then '' else [2] end
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_bcustno = case when '#non' = [5] then '' else [5] end
set @t_ecustno = case when '#non' = [6] then CHAR(255) else [6] end
declare @tmp table(
	gno nvarchar(1),
	noa nvarchar(30),
	noq nvarchar(20),
	datea nvarchar(10),
	cno nvarchar(20),
	typea nvarchar(50),
	custno nvarchar(50),
	comp nvarchar(MAX),
	[money] int,
	chgs int,
	paysales int,
	mons nvarchar(6),
	part nvarchar(10),
	vccno nvarchar(20),
	unpay int,
	checkno nvarchar(20),
	bank nvarchar(20),
	indate nvarchar(10),
	opay int,
	unopay int,
	textopay int
)
--上期餘額
insert into @tmp
	select '0' gno,null,'000',null,null,'上期餘額',a.custno,b.nick,null,null,null,null,null,null,null,
	null,null,null,sum(a.opay),sum(a.unopay),SUM(a.opay)-SUM(a.unopay)
	from umm a left join cust b on a.custno=b.noa
	where (LEN(@t_cno) = 0 or a.cno = @t_cno) and
	(a.datea <@t_bdate) and
	(a.custno between @t_bcustno and @t_ecustno)
	and a.custno!='' and a.noa!=''
	group by a.custno,b.nick
	having sum(a.opay)>0 or sum(a.unopay)>0 or SUM(a.opay)-SUM(a.unopay) >0 --太多客戶會跑很久只顯示有餘額資料的客戶

--指定時間的資料
insert into @tmp
	select '0' gno,a.noa,case when len(b.noq)>0 then b.noq else '001' end,a.datea,a.cno,b.acc2
	,case when c.custno2!='' then c.custno2 when c.custno!='' then c.custno else a.custno end
	,left(case when c.custno2!='' then c.comp2 when c.custno!='' then c.comp else a.comp end,4)
	,b.money,b.chgs,b.paysale,b.mon,b.part,b.vccno,a.unpay
	,b.checkno,b.bank,b.indate,0,0,0
	from umm a
	left join umms b on b.noa = a.noa
	left join view_vcc c on b.vccno=c.noa
	where (LEN(@t_cno) = 0 or a.cno = @t_cno) and
	(LEN(@t_part) = 0 or b.partno = @t_part) and
	(a.datea between @t_bdate and @t_edate) and
	(a.custno between @t_bcustno and @t_ecustno)

	update a
	set a.custno=(select MAX(custno) from @tmp where noa=a.noa)
	,a.comp=(select MAX(comp) from @tmp where noa=a.noa)
	from @tmp a
	where custno=''

declare @noa nvarchar(20)
declare @noq nvarchar(20)
declare @opay float
declare @unopay float
declare cursor_table cursor for
	select noa,'001',opay,unopay from umm
open cursor_table
fetch next from cursor_table
into @noa,@noq,@opay,@unopay
while(@@FETCH_STATUS <> -1)
begin
	update @tmp
	set opay = @opay ,unopay = @unopay,textopay = @opay-@unopay where noa = @noa and noq=@noq
	fetch next from cursor_table
	into @noa,@noq,@opay,@unopay
end
close cursor_table
deallocate cursor_table

declare @t_opay float
set @t_opay=0


insert into @tmp
	select '1' gno,'','',CHAR(255),'','',custno,'',SUM(money),SUM(chgs),SUM(paysales),'','','',0,
	'','','',sum(opay),sum(unopay),sum(opay) - sum(unopay)
	from @tmp
	group by custno

--只保留一筆預收金額
	update @tmp set opay=0 where noq>'001'

select gno,noa,noq,datea,cno,typea,custno,replace(comp,'~#$',char(39)) comp,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,12)) money,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chgs),1)),4,12)) chgs,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,paysales),1)),4,12)) paysales,
	mons,part,vccno,unpay,checkno,bank,indate,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,opay),1)),4,12)) opay,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,unopay),1)),4,12)) unopay,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,textopay),1)),4,12)) textopay
	from @tmp order by custno,datea,gno,noa,noq;
--*************************************************************************************************************************************
z_umm8:--z_umm8
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(50),
	comp nvarchar(MAX),
	bmoney float,
	opay float,
	unopay float,
	opbalance float
)

insert into @tmp
	select '0'gno,a.noa,a.nick
	--前期預收
	,isnull((select SUM(opay-unopay)  from umm where custno=a.noa and datea < @t_bdate),0) bmoney
	--本期預收
	,isnull((select SUM(opay)  from umm where custno=a.noa and datea  between @t_bdate and @t_edate),0) opay
	--本期預收沖帳
	,isnull((select SUM(unopay)  from umm where custno=a.noa and datea between @t_bdate and @t_edate),0) unopay
	,0
from (select noa,nick from cust union all select noa,namea from carOwner union all select ''noa,''namea union all select null noa,null namea)a

delete @tmp where bmoney=0 and opay=0 and opbalance=0 and unopay=0

insert into @tmp
select '1','','',sum(bmoney),sum(opay),sum(unopay),sum(opbalance) from @tmp

select gno,custno,replace(comp,'~#$',char(39)) comp,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,bmoney),1)),4,30)) bmoney,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,opay),1)),4,30)) opays,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unopay),1)),4,30)) unopay,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,bmoney+opay-unopay),1)),4,30)) opbalance
from @tmp order by gno,custno;
--*******************************************************************************************
z_vccj:--z_vccj
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(50)
declare @t_ecustno nvarchar(50)
set @t_bdate = case when '#non'=[3] then '' else [3] end
set @t_edate = case when '#non'=[4] then char(255) else [4] end
set @t_bcustno = case when '#non'=[5] then '' else [5] end
set @t_ecustno = case when '#non'=[6] then char(255) else [6] end

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(50), ----客戶編號
	comp nvarchar(MAX), ----客戶名稱
	vcc_money float, ----出貨金額 > vcc.應收
	vcc_tax float, ----營業稅 > vcc.稅金
	vcc_weight float, ----出貨重量 > if vcc.type = 退 *-1 if vccs.實重>0 then 實重 else vccs.重量
	oinvoice_money float, ----已開發票金額 > vcca.產品金額
	uninvoice_money float, ----未開發票金額 >出貨金額-已開發票金額
	uninvoice_tax float, ----未開發票稅額 > 營業稅 -vcca.稅額
	oinvoice_weight float, ----已開發票重 > vccas.數量
	uninvoice_weight float, ----未開發票重 > 出貨重量-已開發票重
	unsales_money float, ----未開銷貨收入 > if vcc.type = 退 *-1 if len(會計傳票)=0 then vcc.應收 else 0
	unsales_tax float, ----未開銷項稅額 > if vcc.type = 退 *-1  if len(會計傳票)=0 then vcc.稅額 else 0
	dmoney float,	---1123會計借方 
	cmoney float,	---1123會計貸方
	acmoney float,	---會計餘額 (含上期)
	unpay float	--未收餘額CUST_2S
)


insert into @tmp
select '0', (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)
,(select nick from cust where noa=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) union select namea nick from sss where noa=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and  noa not in (select noa from cust))
,isnull((select SUM((case when typea='1' then 1 else -1 end)*total) from view_vcc where custno=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and datea between @t_bdate and @t_edate),0)
,isnull((select SUM((case when typea='1' then 1 else -1 end)*case when taxtype='1' then round(money*0.05,0) when taxtype='3' then round(total/1.05*0.05,0) else 0 end) from view_vcc where custno=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and datea between @t_bdate and @t_edate),0)
,isnull((select SUM((case when va.typea='1' then 1 else -1 end)*(case when vb.gweight>0 then vb.gweight else vb.weight end)) from view_vcc va left join view_vccs vb on va.noa=vb.noa where (case when isnull(va.custno2,'')!='' then va.custno2 else va.custno end)=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and va.datea between @t_bdate and @t_edate),0)
,isnull((select SUM(total) from vcca where custno=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and datea between @t_bdate and @t_edate),0)
-isnull((select SUM(total) from vccb where custno=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and datea between @t_bdate and @t_edate),0)
,isnull((select SUM((case when typea='1' then 1 else -1 end)*total) from view_vcc where (case when isnull(custno2,'')!='' then custno2 else custno end)=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and datea between @t_bdate and @t_edate),0)
-isnull((select SUM(total) from vcca where custno=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and datea between @t_bdate and @t_edate),0)
+isnull((select SUM(total) from vccb where custno=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and datea between @t_bdate and @t_edate),0)
,isnull((select SUM((case when typea='1' then 1 else -1 end)*case when taxtype='1' then round(money*0.05,0) when taxtype='3' then round(total/1.05*0.05,0) else 0 end) from view_vcc where custno=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and datea between @t_bdate and @t_edate),0)
-isnull((select SUM(tax) from vcca where custno=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and datea between @t_bdate and @t_edate),0)
+isnull((select SUM(tax) from vccb where custno=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and datea between @t_bdate and @t_edate),0)
,isnull((select SUM(vb.mount) from vcca va left join vccas vb on va.noa=vb.noa where va.custno=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and va.datea between @t_bdate and @t_edate),0)
-isnull((select SUM(vb.mount) from vccb va left join vccas vb on va.noa=vb.noa where va.custno=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and va.datea between @t_bdate and @t_edate),0)
,isnull((select SUM((case when va.typea='1' then 1 else -1 end)*(case when vb.gweight>0 then vb.gweight else vb.weight end)) from view_vcc va left join view_vccs vb on va.noa=vb.noa where (case when isnull(va.custno2,'')!='' then va.custno2 else va.custno end)=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and va.datea between @t_bdate and @t_edate),0)
-isnull((select SUM(vb.mount) from vcca va left join vccas vb on va.noa=vb.noa where va.custno=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and va.datea between @t_bdate and @t_edate),0)
+isnull((select SUM(vb.mount) from vccb va left join vccas vb on va.noa=vb.noa where va.custno=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and va.datea between @t_bdate and @t_edate),0)
,isnull((select SUM((case when typea='1' then 1 else -1 end)*case when len(accno)=0 then total else 0 end) from view_vcc where (case when isnull(custno2,'')!='' then custno2 else custno end) =(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and datea between @t_bdate and @t_edate),0)
,isnull((select SUM((case when typea='1' then 1 else -1 end)*case when len(accno)=0 then case when taxtype='1' then round(money*0.05,0) when taxtype='3' then round(total/1.05*0.05,0) else 0 end else 0 end) from view_vcc where (case when isnull(custno2,'')!='' then custno2 else custno end)=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) and datea between @t_bdate and @t_edate),0)
,isnull((select SUM(dmoney) from view_acccs[9] where accc5 like '1123%' and (accy+'/'+accc2 between @t_bdate and @t_edate) and right(accc5,len((case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)))=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)),0)
,isnull((select SUM(cmoney) from view_acccs[9] where accc5 like '1123%' and (accy+'/'+accc2 between @t_bdate and @t_edate) and right(accc5,len((case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)))=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)),0)
,isnull((select SUM(dmoney-cmoney) from acccs[9] where accc5 like '1123%' and ('[10]/'+accc2 <= @t_edate) and right(accc5,len((case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)))=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)),0)
,isnull((select sum(unpay) from cust_2s where mon<left(@t_bdate,6) and noa=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)),0)
+isnull((select sum(unpay) from view_vcc where (datea between left(@t_bdate,6)+'/01' and @t_edate) and noa=(case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)),0)
from view_vcc a
where (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno
and a.datea between @t_bdate and @t_edate
group by (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)

select
	gno,custno,replace(comp,'~#$',char(39)) comp,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,vcc_money),1)),4,30)) vcc_money,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,vcc_tax),1)),4,30)) vcc_tax,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,vcc_weight),1)),4,30)) vcc_weight,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,oinvoice_money),1)),4,30)) oinvoice_money,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,uninvoice_money),1)),4,30)) uninvoice_money,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,uninvoice_tax),1)),4,30)) uninvoice_tax,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,oinvoice_weight),1)),4,30)) oinvoice_weight,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,uninvoice_weight),1)),4,30)) uninvoice_weight,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unsales_money),1)),4,30)) unsales_money,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unsales_tax),1)),4,30)) unsales_tax,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,dmoney),1)),4,30)) dmoney,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,cmoney),1)),4,30)) cmoney,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,acmoney),1)),4,30)) acmoney,
	reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unpay),1)),4,30)) unpay
from @tmp;
--*******************************************************************************************
z_umm9:--z_umm9 ref:z_vcc4
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bmon nvarchar(7)
declare @t_emon nvarchar(7)
declare @t_bcustno nvarchar(50)
declare @t_ecustno nvarchar(50)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
set @t_bdate = case when '#non'='#non' then '' else '#non' end
set @t_edate = case when '#non'='#non' then char(255) else '#non' end
set @t_bmon = case when '#non'=[13] then '' else [13] end
set @t_emon = case when '#non'=[14] then char(255) else [14] end
set @t_bcustno = case when '#non'=[5] then '' else [5] end
set @t_ecustno = case when '#non'=[6] then char(255) else [6] end
set @t_bsalesno = case when '#non'='#non' then '' else '#non' end
set @t_esalesno = case when '#non'='#non' then char(255) else '#non' end
set @t_bproductno = case when '#non'='#non' then '' else '#non' end
set @t_eproductno = case when '#non'='#non' then char(255) else '#non' end
--***********************************************************************************
declare @result table(
	gno nvarchar(1),
	typea nvarchar(4),
	noa nvarchar(30),
	noq nvarchar(10),
	datea nvarchar(10),
	mon nvarchar(7),
	custno nvarchar(50),
	comp nvarchar(MAX),
	addr_invo nvarchar(90),
	tel nvarchar(90),
	productno nvarchar(30),
	xproduct nvarchar(40),
	unit nvarchar(8),
	mount decimal(16,2),
	weight decimal(16,2),
	price decimal(16,2),
	total decimal(18,0),
	money decimal(18,0),
	back decimal(18,0),
	tax decimal(18,0),
	total1 decimal(18,0),
	pay decimal(18,0),
	unpay decimal(18,0),
	total2 decimal(18,0),
	pcount int
	primary key (custno,gno,mon,datea,noa,noq)
)

insert into @result
	select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when a.mon='' then left(a.datea,6) else a.mon end) mon,
		   a.custno custno, isnull(c.nick,c.comp), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
	       b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
	from view_vccs b
	left join view_vcc a on a.noa = b.noa
	left join cust c on  a.custno = c.noa
	where ((case when a.mon='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
		  (a.custno between @t_bcustno and @t_ecustno) and
		  (a.salesno between @t_bsalesno and @t_esalesno) and
		  (b.productno between @t_bproductno and @t_eproductno)
	union all
	select '0' gno, '稅' typea, noa, CHAR(255) noq, datea, (case when mon='' then left(datea,6) else mon end),
		   custno, '' comp, '' addr_invo, '' tel, '' productno, '進項稅額' product, '' unit,
		   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
	from view_vcc
	where tax > 0 and ((case when mon='' then left(datea,6) else mon end) between @t_bmon and @t_emon) and
		  (custno between @t_bcustno and @t_ecustno)
	union all
	select '0' gno, '稅' typea, noa, '' noq, datea, (case when mon='' then left(datea,6) else mon end),
		   custno, '' comp, '' addr_invo, '' tel, '' productno, '銷項稅額' product, '' unit,
		   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
	from vcca
	where tax > 0 and ((case when mon='' then left(datea,6) else mon end) between @t_bmon and @t_emon) and
		  (custno between @t_bcustno and @t_ecustno)
	order by custno,gno,mon,datea,noa,noq
declare @gno nvarchar(1)
declare @typea nvarchar(4)
declare @noa nvarchar(30)
declare @total decimal(18,0)
declare @mon nvarchar(7)
declare @custno nvarchar(50)
declare @comp nvarchar(MAX)
declare @t_custno nvarchar(50)
declare @t_ar(MAX)
declare @t_money decimal(18,0)
declare @t_back decimal(18,0)
declare @t_tax decimal(18,0)
declare @t_total1 decimal(18,0)
declare @t_pay decimal(18,0)
declare @t_unpay decimal(18,0)
declare @t_total2 decimal(18,0)
declare @t_pcount int
set @t_custno = '#zzzz#zzzz'
set @t_comp = ''
set @t_money = 0
set @t_back = 0
set @t_tax = 0
set @t_total1 = 0
set @t_pay = 0
set @t_unpay = 0
set @t_total2 = 0
set @t_pcount = 0
declare cursor_table cursor for
	select gno,typea,custno,comp,mon,total from @result
open cursor_table
fetch next from cursor_table
into @gno,@typea,@custno,@comp,@mon,@total
while(@@FETCH_STATUS <> -1)
begin
	if @t_custno != @custno
	begin
		if @t_custno != '#zzzz#zzzz'
		begin
			set @t_total1 = @t_money - @t_back + @t_tax
			insert into @result
			select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel,
			       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total,
				   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount
		end
		set @t_custno = @custno
		set @t_comp = @comp
		set @t_money = case when @typea = '1' then @total else 0 end
		set @t_back = case when @typea = '2' then @total else 0 end
		set @t_tax = case when @typea = '稅' then @total else 0 end
		set @t_pcount = 1
	end
	else
	begin
		set @t_money = @t_money + case when @typea = '1' then @total else 0 end
		set @t_back = @t_back + case when @typea = '2' then @total else 0 end
		set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
		set @t_pcount = @t_pcount + 1
	end
	fetch next from cursor_table
	into @gno,@typea,@custno,@comp,@mon,@total
end
close cursor_table
deallocate cursor_table
if @t_custno != '#zzzz#zzzz'
begin
	set @t_total1 = @t_money - @t_back + @t_tax
	insert into @result
	select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel,
		       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total,
			   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount
	end
	update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
	--已收款
	update a
	set pay=isnull((select SUM(paysale) from umms where vccno in(select noa from @result where noa!='' and custno=a.custno)),0)
	+isnull((select SUM(ub.paysale) from umm ua left join umms ub on ua.noa=ub.noa where CHARINDEX(a.custno,ub.vccno)>0 and left (ua.datea,6)  between @t_bmon and @t_emon),0)
	from @result a where a.gno='1'
	--前期
	declare @tmp table(
		gno nvarchar(1),
		typea nvarchar(4),
		noa nvarchar(30),
		noq nvarchar(10),
		datea nvarchar(10),
		mon nvarchar(7),
		custno nvarchar(50),
		comp nvarchar(MAX),
		addr_invo nvarchar(90),
		tel nvarchar(90),
		productno nvarchar(30),
		xproduct nvarchar(40),
		unit nvarchar(8),
		mount decimal(16,2),
		weight decimal(16,2),
		price decimal(16,2),
		total decimal(18,0),
		money decimal(18,0),
		back decimal(18,0),
		tax decimal(18,0),
		total1 decimal(18,0),
		pay decimal(18,0),
		unpay decimal(18,0),
		total2 decimal(18,0),
		pcount int
		primary key (custno,gno,mon,datea,noa,noq)
	)

	insert into @tmp
		select '0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when a.mon='' then left(a.datea,6) else a.mon end) mon,
			   a.custno custno, isnull(c.nick,c.comp), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
		       b.mount, b.weight, b.price, b.total, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
		from view_vccs b
		left join view_vcc a on a.noa = b.noa
		left join cust c on  a.custno = c.noa
		where ((case when a.mon='' then left(a.datea,6) else a.mon end) < @t_bmon ) and
			  (a.custno between @t_bcustno and @t_ecustno) and
			  (a.salesno between @t_bsalesno and @t_esalesno) and
			  (b.productno between @t_bproductno and @t_eproductno)
		union all
		select '0' gno, '稅' typea, noa, CHAR(255) noq, datea, (case when mon='' then left(datea,6) else mon end),
			   custno, '' comp, '' addr_invo, '' tel, '' productno, '進項稅額' product, '' unit,
			   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
		from view_vcc
		where tax > 0 and ((case when mon='' then left(datea,6) else mon end) < @t_bmon) and
			  (custno between @t_bcustno and @t_ecustno)
		union all
		select '0' gno, '稅' typea, noa, '' noq, datea, (case when mon='' then left(datea,6) else mon end),
			   custno, '' comp, '' addr_invo, '' tel, '' productno, '銷項稅額' product, '' unit,
			   0 mount, 0 weight, 0 price, tax, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
		from vcca
		where tax > 0 and ((case when mon='' then left(datea,6) else mon end) < @t_bmon ) and
			  (custno between @t_bcustno and @t_ecustno)
		order by custno,gno,mon,datea,noa,noq
	set @t_custno = '#zzzz#zzzz'
	set @t_comp = ''
	set @t_money = 0
	set @t_back = 0
	set @t_tax = 0
	set @t_total1 = 0
	set @t_pay = 0
	set @t_unpay = 0
	set @t_total2 = 0
	set @t_pcount = 0
	declare cursor_table cursor for
		select gno,typea,custno,comp,mon,total from @tmp
	open cursor_table
	fetch next from cursor_table
	into @gno,@typea,@custno,@comp,@mon,@total
	while(@@FETCH_STATUS <> -1)
	begin
		if @t_custno != @custno
		begin
			if @t_custno != '#zzzz#zzzz'
			begin
				set @t_total1 = @t_money - @t_back + @t_tax
				insert into @tmp
				select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel,
				       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total,
					   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount
			end
			set @t_custno = @custno
			set @t_comp = @comp
			set @t_money = case when @typea = '1' then @total else 0 end
			set @t_back = case when @typea = '2' then @total else 0 end
			set @t_tax = case when @typea = '稅' then @total else 0 end
			set @t_pcount = 1
		end
		else
		begin
			set @t_money = @t_money + case when @typea = '1' then @total else 0 end
			set @t_back = @t_back + case when @typea = '2' then @total else 0 end
			set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
			set @t_pcount = @t_pcount + 1
		end
		fetch next from cursor_table
		into @gno,@typea,@custno,@comp,@mon,@total
	end
	close cursor_table
	deallocate cursor_table

if @t_custno != '#zzzz#zzzz'
begin
	set @t_total1 = @t_money - @t_back + @t_tax
	insert into @tmp
	select '1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel,
	       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total,
		   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount
end
update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'
--已收款
update a
	set pay=isnull((select SUM(paysale) from umms where vccno in(select noa from @result where noa!='' and custno=a.custno)),0)
	+isnull((select SUM(ub.paysale) from umm ua left join umms ub on ua.noa=ub.noa where CHARINDEX(a.custno,ub.vccno)>0 and left(ua.datea,6)  < @t_bmon ),0)
from @tmp a where a.gno='1'

update a
	set unpay=isnull((select total1-pay from @tmp where custno=a.custno and gno='1'),0)
from @result a where a.gno='1'

update @result
	set total2=total1+unpay-pay
where gno='1'

select
	'0'gno,typea,noa,noq,datea,mon,custno,comp,addr_invo,tel,productno,replace(xproduct,'~#$',char(39)) xproduct,unit
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),0,30)) mount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,weight),1)),0,30)) weight
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),0,30)) price
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),4,30)) total
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,money),1)),4,30)) money
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,back),1)),4,30)) back
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,tax),1)),4,30)) tax
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total1),1)),4,30)) total1
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,pay),1)),4,30)) pay
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unpay),1)),4,30)) unpay
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total2),1)),4,30)) total2
	,pcount
from @result where gno='1' order by custno,gno,mon,datea,noa,noq;
--********************************************************************************************
z_umm10:--z_umm10
declare @t_cno nvarchar(20)
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bmon nvarchar(7)
declare @t_emon nvarchar(7)
declare @t_bcustno nvarchar(50)
declare @t_ecustno nvarchar(50)
declare @t_bsalesno nvarchar(50)
declare @t_esalesno nvarchar(50)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_showunpay nvarchar(30)
declare @t_xcoin nvarchar(20)
declare @t_showordetotal nvarchar(30)
declare @t_multcust nvarchar(max)

set @t_cno = case when '#non' = [1] then '' else [1] end
set @t_bdate = case when '#non'=[3] then '' else [3] end
set @t_edate = case when '#non'=[4] then char(255) else [4] end
set @t_bmon = case when '#non'=[13] then '' else [13] end
set @t_emon = case when '#non'=[14] then char(255) else [14] end
set @t_bcustno = case when '#non'=[5] then '' else [5] end
set @t_ecustno = case when '#non'=[6] then char(255) else [6] end
set @t_bsalesno = case when '#non'=[15] then '' else [15] end
set @t_esalesno = case when '#non'=[16] then char(255) else [16] end
set @t_bproductno = case when '#non'=[17] then '' else [17] end
set @t_eproductno = case when '#non'=[18] then char(255) else [18] end
set @t_showunpay = case when '#non'=[22] then '0' else [22] end
set @t_xcoin = case when '#non' = [27] then '' else [27] end
set @t_showordetotal = case when '#non'=[28] then '0' else [28] end
set @t_multcust = case when '#non' = [29] then '' else '.'+[29]+'.' end
declare @t_project nvarchar(50)=case when '#non' = '[26]' then '' else '[26]' end
-------------------------------------------------------------------------------------------------------------------------
declare @coin nvarchar(20)
declare @cmd nvarchar(max) 
IF OBJECT_ID('tempdb..#result')is not null
BEGIN
	set @cmd = 'drop table #result'
	EXECUTE sp_executesql @cmd
END

create table #result(
	coin nvarchar(20),
	gno nvarchar(1),
	typea nvarchar(4),
	noa nvarchar(30),
	noq nvarchar(10),
	datea nvarchar(10),
	mon nvarchar(7),
	custno nvarchar(50),
	comp nvarchar(MAX),
	addr_invo nvarchar(90),
	tel nvarchar(90),
	productno nvarchar(MAX),
	xproduct nvarchar(MAX),
	unit nvarchar(8),
	mount decimal(16,4),
	weight decimal(16,4),
	price decimal(16,4),
	total decimal(18,0),
	money decimal(18,0),
	back decimal(18,0),
	tax decimal(18,0),
	total1 decimal(18,0),
	pay decimal(18,0),
	unpay decimal(18,0),
	total2 decimal(18,0),
	pcount int,
	salesno nvarchar(30),
	saless nvarchar(30)
	primary key (coin,custno,gno,mon,datea,noa,noq)
)

if(@t_showunpay='0')
begin
	insert into #result
		select @t_xcoin,'0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
			   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
		       b.mount, b.weight, b.price*coin.floata, b.total*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
		       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
		from view_vccs b
		left join view_vcc a on a.noa = b.noa
		left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
		where --(a.datea between @t_bdate and @t_edate) and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ((case when a.custno2!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno) and
			  (b.productno between @t_bproductno and @t_eproductno) and (len(@t_cno)=0 or a.cno=@t_cno)and
			  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0 or CHARINDEX('.'+a.custno2+'.',@t_multcust)>0)
		union all --無發票系統
		select @t_xcoin,'0' gno, '稅' typea, a.noa, CHAR(255) noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
			   0 mount, 0 weight, 0 price, (case when a.typea!='1' then -1 else 1 end) * tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
			   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
		from view_vcc a
		left join cust c on (case when a.custno2!='' then a.custno2 else a.custno end) = c.noa 
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
		where tax > 0 and (taxtype='1' or taxtype='5') and
			  --(a.datea between @t_bdate and @t_edate)and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ( (case when isnull(a.custno2,'') !='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
			  and (len(@t_cno)=0 or a.cno=@t_cno)and
			  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0 or CHARINDEX('.'+a.custno2+'.',@t_multcust)>0)
		union all --有發票系統
		select @t_xcoin,'0' gno, '稅' typea, a.noa, '' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   a.custno, '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
			   0 mount, 0 weight, 0 price, a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
			   ,c.salesno,c.sales
		from vcca a left join cust c on a.custno = c.noa
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin 
		where tax > 0 and (taxtype='1' or taxtype='5') and ([21]!=3) and
				--(a.datea between @t_bdate and @t_edate)and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and
			  (isnull(c.salesno,'') between @t_bsalesno and @t_esalesno) and (len(@t_cno)=0 or a.cno=@t_cno)and
			  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0)
			  
		union all --折讓--義橋
		select @t_xcoin,'0' gno, '折' typea, a.noa, '999' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '折讓' product, '' unit,
			   0 mount, 0 weight, 0 price, (case when a.typea!='1' then 1 else -1 end) * a.discount*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
			   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
		from view_vcc a
		left join cust c on (case when a.custno2!='' then a.custno2 else a.custno end) = c.noa 
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
		where a.discount > 0 and @t_project='YC' and
			  --(a.datea between @t_bdate and @t_edate)and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ( (case when isnull(a.custno2,'') !='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
			  and (len(@t_cno)=0 or a.cno=@t_cno)and
			  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0 or CHARINDEX('.'+a.custno2+'.',@t_multcust)>0)
		order by custno,gno,mon,datea,noa,noq
end
else
begin
	insert into #result
	select @t_xcoin,'0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
			   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
		       b.mount, b.weight, b.price*coin.floata, b.total*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
		       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
		from view_vccs b
		left join view_vcc a on a.noa = b.noa
		left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
		where --(a.datea between @t_bdate and @t_edate) and 
			a.unpay>0 and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ((case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno) and
			  (b.productno between @t_bproductno and @t_eproductno) and (len(@t_cno)=0 or a.cno=@t_cno)and
			  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0 or CHARINDEX('.'+a.custno2+'.',@t_multcust)>0)
		union all --無發票系統
		select @t_xcoin,'0' gno, '稅' typea, a.noa, CHAR(255) noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   (case when a.custno2!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
			   0 mount, 0 weight, 0 price, (case when a.typea!='1' then -1 else 1 end) *a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
			   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
		from view_vcc a
		left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
		where tax > 0 and (a.taxtype='1' or a.taxtype='5') and
			  --(a.datea between @t_bdate and @t_edate) and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ( (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
			  and (len(@t_cno)=0 or a.cno=@t_cno)and
			  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0 or CHARINDEX('.'+a.custno2+'.',@t_multcust)>0)
		union all --有發票系統
		select @t_xcoin,'0' gno, '稅' typea, a.noa, '' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   custno, '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
			   0 mount, 0 weight, 0 price, a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
			   ,c.salesno,c.sales
		from vcca a left join cust c on a.custno = c.noa
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin 
		where tax > 0 and (a.taxtype='1' or a.taxtype='5') and ([21]!=3) and
				--(a.datea between @t_bdate and @t_edate)and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and 
			  (isnull(c.salesno,'') between @t_bsalesno and @t_esalesno) and (len(@t_cno)=0 or a.cno=@t_cno)and
			  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0)
			  
		union all --折讓--義橋
		select @t_xcoin,'0' gno, '折' typea, a.noa, '999' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   (case when a.custno2!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '折讓' product, '' unit,
			   0 mount, 0 weight, 0 price, (case when a.typea!='1' then 1 else -1 end) *a.discount*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
			   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
		from view_vcc a
		left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
		where a.discount > 0 and @t_project='YC' and
			  --(a.datea between @t_bdate and @t_edate) and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ( (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
			  and (len(@t_cno)=0 or a.cno=@t_cno)and
			  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0 or CHARINDEX('.'+a.custno2+'.',@t_multcust)>0)
		order by custno,gno,mon,datea,noa,noq
end

if(@t_xcoin='ALL')
begin
	declare cursor_table cursor for
	select coin from flors group by coin
	open cursor_table
	fetch next from cursor_table
	into @coin
	while(@@FETCH_STATUS <> -1)
	begin
		
		if(@t_showunpay='0')
		begin
			insert into #result
				select @coin,'0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
					   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
				       b.mount, b.weight, b.price*coin.floata, b.total*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
				       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
						,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
				from view_vccs b
				left join view_vcc a on a.noa = b.noa
				left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
				outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
				where --(a.datea between @t_bdate and @t_edate) and
					  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
					  ((case when a.custno2!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
					  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno) and
					  (b.productno between @t_bproductno and @t_eproductno) and (len(@t_cno)=0 or a.cno=@t_cno)and
					  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0 or CHARINDEX('.'+a.custno2+'.',@t_multcust)>0)
				union all --無發票系統
				select @coin,'0' gno, '稅' typea, a.noa, CHAR(255) noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
					   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
					   0 mount, 0 weight, 0 price, (case when a.typea!='1' then -1 else 1 end) * tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
					   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
						,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
				from view_vcc a
				left join cust c on (case when a.custno2!='' then a.custno2 else a.custno end) = c.noa 
				outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
				where tax > 0 and (taxtype='1' or taxtype='5') and
					  --(a.datea between @t_bdate and @t_edate) and
					  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
					  ( (case when isnull(a.custno2,'') !='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
					  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
					  and (len(@t_cno)=0 or a.cno=@t_cno)and
					  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0 or CHARINDEX('.'+a.custno2+'.',@t_multcust)>0)
				union all --有發票系統
				select @coin,'0' gno, '稅' typea, a.noa, '' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
					   a.custno, '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
					   0 mount, 0 weight, 0 price, a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
					   ,c.salesno,c.sales
				from vcca a left join cust c on a.custno = c.noa
				outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin 
				where tax > 0 and (taxtype='1' or taxtype='5') and ([21]!=3) and
						--(a.datea between @t_bdate and @t_edate) and
					  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
					  (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and
					  (isnull(c.salesno,'') between @t_bsalesno and @t_esalesno) and (len(@t_cno)=0 or a.cno=@t_cno)and
					  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0)
				order by custno,gno,mon,datea,noa,noq
		end
		else
		begin
			insert into #result
			select @coin,'0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
					   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
				       b.mount, b.weight, b.price*coin.floata, b.total*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
				       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
						,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
				from view_vccs b
				left join view_vcc a on a.noa = b.noa
				left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
				outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
				where --(a.datea between @t_bdate and @t_edate) and 
					a.unpay>0 and
					  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
					  ((case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
					  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno) and
					  (b.productno between @t_bproductno and @t_eproductno) and (len(@t_cno)=0 or a.cno=@t_cno)and
					  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0 or CHARINDEX('.'+a.custno2+'.',@t_multcust)>0)
				union all --無發票系統
				select @coin,'0' gno, '稅' typea, a.noa, CHAR(255) noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
					   (case when a.custno2!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
					   0 mount, 0 weight, 0 price, (case when a.typea!='1' then -1 else 1 end) *a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
					   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
						,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
				from view_vcc a
				left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
				outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
				where tax > 0 and (a.taxtype='1' or a.taxtype='5') and
					  --(a.datea between @t_bdate and @t_edate) and
					  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
					  ( (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
					  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
					  and (len(@t_cno)=0 or a.cno=@t_cno)and
					  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0 or CHARINDEX('.'+a.custno2+'.',@t_multcust)>0)
				union all --有發票系統
				select @coin,'0' gno, '稅' typea, a.noa, '' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
					   custno, '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
					   0 mount, 0 weight, 0 price, a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
					   ,c.salesno,c.sales
				from vcca a left join cust c on a.custno = c.noa
				outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin 
				where tax > 0 and (a.taxtype='1' or a.taxtype='5') and ([21]!=3) and
						--(a.datea between @t_bdate and @t_edate) and
					  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
					  (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and 
					  (isnull(c.salesno,'') between @t_bsalesno and @t_esalesno) and (len(@t_cno)=0 or a.cno=@t_cno)and
					  (@t_multcust='' or CHARINDEX('.'+a.custno+'.',@t_multcust)>0)
				order by custno,gno,mon,datea,noa,noq
		end

		fetch next from cursor_table
		into @coin
	
	end
	close cursor_table
	deallocate cursor_table
end

declare @t_coin nvarchar(20)
declare @gno nvarchar(1)
declare @typea nvarchar(4)
declare @noa nvarchar(30)
declare @total decimal(18,0)
declare @mon nvarchar(7)
declare @custno nvarchar(50)
declare @comp nvarchar(MAX)
declare @t_custno nvarchar(50)
declare @t_comp nvarchar(MAX)
declare @t_money decimal(18,0)
declare @t_back decimal(18,0)
declare @t_tax decimal(18,0)
declare @t_total1 decimal(18,0)
declare @t_pay decimal(18,0)
declare @t_unpay decimal(18,0)
declare @t_total2 decimal(18,0)
declare @t_pcount int
set @t_custno = '#zzzz#zzzz'
set @t_coin = '#zzzz#zzzz'
set @t_comp = ''
set @t_money = 0
set @t_back = 0
set @t_tax = 0
set @t_total1 = 0
set @t_pay = 0
set @t_unpay = 0
set @t_total2 = 0
set @t_pcount = 0

--declare cursor_table cursor for
--select coin,gno,typea,custno,comp,mon,total from #result order by coin,custno
--open cursor_table
--fetch next from cursor_table
--into @coin,@gno,@typea,@custno,@comp,@mon,@total
--while(@@FETCH_STATUS <> -1)
--begin
--	if @t_custno != @custno or @t_coin!=@coin
--	begin
--		if @t_custno != '#zzzz#zzzz' and @t_coin!='#zzzz#zzzz'
--		begin
--			set @t_total1 = @t_money - @t_back + @t_tax
--			insert into #result
--			select @t_coin,'1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel,
--			       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total,
--				   @t_money, @t_back, @t_tax, @t_total1
--				   , isnull((select sum(ub.paysale) from umms ub where ub.vccno in (select noa from #result where gno='0' and custno=@t_custno)),0) --單據
--					+isnull((select sum(ub.paysale) from umms ub where (ub.custno+'-'+ub.paymon=ub.vccno 
--					and (ub.paymon between @t_bmon and @t_emon) and (ub.paymon+'/01' between @t_bdate and @t_edate) 
--					and ub.custno=@t_custno)),0) --月結
--					 pay
--				   , 0 unpay, 0 total2, @t_pcount,'',''
--		end
--		set @t_custno = @custno
--		set @t_coin = @coin
--		set @t_comp = @comp
--		set @t_money = case when @typea = '1' then @total else 0 end
--		set @t_back = case when @typea = '2' then @total else 0 end
--		set @t_tax = case when @typea = '稅' then @total else 0 end
--		set @t_pcount = 1
--	end
--	else
--	begin
--		set @t_money = @t_money + case when @typea = '1' then @total else 0 end
--		set @t_back = @t_back + case when @typea = '2' then @total else 0 end
--		set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
--		set @t_pcount = @t_pcount + 1
--	end
--	fetch next from cursor_table
--	into @coin,@gno,@typea,@custno,@comp,@mon,@total
--end
--close cursor_table
--deallocate cursor_table

--if @t_custno != '#zzzz#zzzz' and @t_coin!='#zzzz#zzzz'
--begin
--	set @t_total1 = @t_money - @t_back + @t_tax
--	insert into #result
--	select @t_coin,'1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel,
--			'' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total,
--			@t_money, @t_back, @t_tax, @t_total1
--			, isnull((select sum(ub.paysale) from umms ub where ub.vccno in (select noa from #result where gno='0' and custno=@t_custno)),0) --單據
--			+isnull((select sum(ub.paysale) from umms ub where (ub.custno+'-'+ub.paymon=ub.vccno 
--			and (ub.paymon between @t_bmon and @t_emon) and (ub.paymon+'/01' between @t_bdate and @t_edate) 
--			and ub.custno=@t_custno)),0) --月結
--			 pay
--			, 0 unpay, 0 total2, @t_pcount,'',''
--end

insert #result
select coin,'1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, custno, MAX(comp) comp, '' addr_invo, '' tel, '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
sum(case when typea in ('1','折') then total else 0 end), sum(case when typea = '2' then total else 0 end)
,SUM(case when typea = '稅' then total else 0 end) , 0
, isnull((select sum(ub.paysale) from umms ub where exists (select noa from #result where ub.vccno=noa and gno='0' and custno=a.custno)),0) --單據 
+isnull((select sum(ub.paysale) from umms ub where (ub.custno+'-'+ub.paymon=ub.vccno 
and (ub.paymon between @t_bmon and @t_emon) --and (ub.paymon+'/01' between @t_bdate and @t_edate) 
and ub.custno=a.custno)),0) --月結 
pay , 0 unpay, 0 total2, count(*),'',''  from #result a group by custno,coin

update #result set total1=money-back+tax where gno='1'
	
update #result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

--104/05/07單據插入小計
if(@t_showordetotal='1')
begin
	insert #result
	select coin,'2',CHAR(255),noa,CHAR(255),datea,mon,custno,MAX(comp),MAX(addr_invo),MAX(tel),'','',''
	,null,null,null,SUM(total),null,null
	,isnull((select sum(tax) from view_vcc where noa=a.noa),0)
	+isnull((select sum(cb.tax) from view_vcc ca left join vcca cb on ca.invono=cb.noa where ca.noa=a.noa and (ca.taxtype='1' or ca.taxtype='5') and [21]!=3),0)
	,null,null,null,null,null,MAX(salesno),MAX(saless)
	from #result a where gno='0' and typea!='稅'
	group by coin,gno,noa,datea,mon,custno
end
--已收款
--update a 
--set pay=isnull((select SUM(paysale*coin.floata) from umms ub
--						left join view_vcc va on ub.vccno=va.noa
--						outer apply (select isnull((select top 1 floata from flors where coin=a.coin and va.datea <=edate order by edate desc,noa desc),1) floata) coin
--						where vccno in(select noa from #result where noa!='' and custno=a.custno)),0) --本期單據以沖金額 
--+isnull((select SUM(ub.paysale*coin.floata) from umms ub 
--			left join view_vcc va on ub.vccno=va.noa
--			outer apply (select isnull((select top 1 floata from flors where coin=a.coin and ub.mon <=edate order by edate desc,noa desc),1) floata) coin
--			where charindex(a.custno+'-',ub.vccno)>0 
--			and SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6)+'/01' between @t_bdate and @t_edate 
--			and SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6) between @t_bmon and @t_emon),0) --找出月結客戶與稅的內容 
--from #result a 
--where a.gno='1'

--104/01/31
--update a 
--set pay= 
--isnull((select sum(ub.paysale) from umms ub where ub.vccno=a.noa),0) 
--from #result a 
--where a.gno='0' and noa!=''

--update a 
--set pay= 
--isnull((select sum(pay) from #result where custno=a.custno and gno='0'),0) --單據
--+isnull((select sum(ub.paysale) from umms ub where (ub.custno+'-'+ub.paymon=ub.vccno
--and (ub.paymon between @t_bmon and @t_emon) and (ub.paymon+'/01' between @t_bdate and @t_edate) 
--and ub.custno=a.custno)),0) --月結
--from #result a 
--where a.gno='1' 

---begin 前期---------------------------------------------------------------------------------------------------
--declare @tmp table(
--	coin nvarchar(20),
--	gno nvarchar(1),
--	typea nvarchar(4),
--	noa nvarchar(30),
--	noq nvarchar(10),
--	datea nvarchar(10),
--	mon nvarchar(7),
--	custno nvarchar(50),
--	comp nvarchar(MAX),
--	addr_invo nvarchar(90),
--	tel nvarchar(90),
--	productno nvarchar(MAX),
--	xproduct nvarchar(MAX),
--	unit nvarchar(8),
--	mount decimal(16,2),
--	weight decimal(16,2),
--	price decimal(16,2),
--	total decimal(18,0),
--	money decimal(18,0),
--	back decimal(18,0),
--	tax decimal(18,0),
--	total1 decimal(18,0),
--	pay decimal(18,0),
--	unpay decimal(18,0),
--	total2 decimal(18,0),
--	pcount int,
--	salesno nvarchar(30),
--	saless nvarchar(30)
--	primary key (coin,custno,gno,mon,datea,noa,noq)
--)

--insert into @tmp
--	select @t_xcoin,'0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
--		    (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
--	       b.mount, b.weight, b.price*coin.floata, b.total*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
--	       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
--			,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
--	from view_vccs b	left join view_vcc a on a.noa = b.noa
--	left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)  = c.noa
--	outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
--	where ((a.datea < @t_bdate ) or ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) < @t_bmon ))
--		  and ( (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno)
--		  and ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
--		  and (b.productno between @t_bproductno and @t_eproductno)
--	union all
--	select @t_xcoin,'0' gno, '稅' typea, a.noa, CHAR(255) noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
--		    (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
--		   0 mount, 0 weight, 0 price, (case when a.typea!='1' then -1 else 1 end) *a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
--		   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
--			,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
--	from view_vcc a left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)  = c.noa
--	outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
--	where tax > 0 and (taxtype='1' or taxtype='5')
--		  and ((a.datea < @t_bdate) or ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) < @t_bmon))
--		  and ((case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno)
--		  and ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
--	union all
--	select @t_xcoin,'0' gno, '稅' typea, a.noa, '' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
--		   custno, '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
--		   0 mount, 0 weight, 0 price, a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
--			,c.salesno,c.sales
--	from vcca a left join cust c on a.custno = c.noa
--	outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin 
--	where tax > 0 and (a.taxtype='1' or a.taxtype='5') and ([21]!=3)
--		and ((a.datea < @t_bdate) or ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) < @t_bmon ))
--		and  (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and
--		(isnull(c.salesno,'') between @t_bsalesno and @t_esalesno)
--	order by custno,gno,mon,datea,noa,noq

--if(@t_xcoin='ALL')
--begin
--	declare cursor_table cursor for
--	select coin from flors group by coin
--	open cursor_table
--	fetch next from cursor_table
--	into @coin
--	while(@@FETCH_STATUS <> -1)
--	begin
		
--		insert into @tmp
--		select @coin,'0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
--			    (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
--		       b.mount, b.weight, b.price*coin.floata, b.total*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
--		       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
--				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
--		from view_vccs b	left join view_vcc a on a.noa = b.noa
--		left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)  = c.noa
--		outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
--		where ((a.datea < @t_bdate ) or ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) < @t_bmon ))
--			  and ( (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno)
--			  and ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
--			  and (b.productno between @t_bproductno and @t_eproductno)
--		union all
--		select @coin,'0' gno, '稅' typea, a.noa, CHAR(255) noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
--			    (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
--			   0 mount, 0 weight, 0 price, (case when a.typea!='1' then -1 else 1 end) *a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
--			   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
--				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
--		from view_vcc a left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)  = c.noa
--		outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
--		where tax > 0 and (taxtype='1' or taxtype='5')
--			  and ((a.datea < @t_bdate) or ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) < @t_bmon))
--			  and ((case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno)
--			  and ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
--		union all
--		select @coin,'0' gno, '稅' typea, a.noa, '' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
--			   custno, '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
--			   0 mount, 0 weight, 0 price, a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
--				,c.salesno,c.sales
--		from vcca a left join cust c on a.custno = c.noa
--		outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin 
--		where tax > 0 and (a.taxtype='1' or a.taxtype='5') and ([21]!=3)
--			and ((a.datea < @t_bdate) or ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) < @t_bmon ))
--			and  (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and
--			(isnull(c.salesno,'') between @t_bsalesno and @t_esalesno)
--		order by custno,gno,mon,datea,noa,noq
	
--		fetch next from cursor_table
--		into @coin
	
--	end
--	close cursor_table
--	deallocate cursor_table
--end


--set @t_coin = '#zzzz#zzzz'
--set @t_custno = '#zzzz#zzzz'
--set @t_comp = ''
--set @t_money = 0
--set @t_back = 0
--set @t_tax = 0
--set @t_total1 = 0
--set @t_pay = 0
--set @t_unpay = 0
--set @t_total2 = 0
--set @t_pcount = 0
--declare @salesno nvarchar(30) =''
--declare @sales nvarchar(30) =''

--declare cursor_table cursor for
--	select coin,gno,typea,custno,comp,mon,total,salesno,saless from @tmp order by coin,custno
--open cursor_table
--fetch next from cursor_table
--into @coin,@gno,@typea,@custno,@comp,@mon,@total,@salesno,@sales
--while(@@FETCH_STATUS <> -1)
--begin
--	if @t_custno != @custno or @t_coin !=@coin
--	begin
--		if @t_custno != '#zzzz#zzzz' and @t_coin!='#zzzz#zzzz'
--		begin
--			set @t_total1 = @t_money - @t_back + @t_tax
--			insert into @tmp
--			select @t_coin,'1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel,
--			       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total,
--				   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,@salesno,@sales
--		end
--		set @t_coin = @coin
--		set @t_custno = @custno
--		set @t_comp = @comp
--		set @t_money = case when @typea = '1' then @total else 0 end
--		set @t_back = case when @typea = '2' then @total else 0 end
--		set @t_tax = case when @typea = '稅' then @total else 0 end
--		set @t_pcount = 1
--	end
--	else
--	begin
--		set @t_money = @t_money + case when @typea = '1' then @total else 0 end
--		set @t_back = @t_back + case when @typea = '2' then @total else 0 end
--		set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
--		set @t_pcount = @t_pcount + 1
--		end
--	fetch next from cursor_table
--	into @coin,@gno,@typea,@custno,@comp,@mon,@total,@salesno,@sales
--end
--close cursor_table
--deallocate cursor_table

--if @t_custno != '#zzzz#zzzz' and @t_coin!='#zzzz#zzzz'
--begin
--	set @t_total1 = @t_money - @t_back + @t_tax
--	insert into @tmp
--	select @t_coin,'1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel,
--		       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total,
--			   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,@salesno,@sales
--end

--update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

----已收款
--update a
--	set pay=isnull((select SUM(paysale*coin.floata) from umms ub left join view_vcc va on ub.vccno=va.noa
--	outer apply (select isnull((select top 1 floata from flors where coin=a.coin and va.datea <=edate order by edate desc,noa desc),1) floata) coin
--	where vccno in(select noa from @tmp where noa!='' and custno=a.custno)),0) --本期單據以沖金額
--	+isnull((select SUM(ub.paysale*coin.floata) from umms ub left join view_vcc va on ub.vccno=va.noa
--	outer apply (select isnull((select top 1 floata from flors where coin=a.coin and ub.mon <=edate order by edate desc,noa desc),1) floata) coin
--				where charindex(a.custno+'-',ub.vccno)>0
--				and (SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6)+'/01' < @t_bdate
--				or SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6) < @t_bmon) ),0) --找出月結客戶與稅的內容
--from @tmp a where a.gno='1'

declare @tmp table( 
	coin nvarchar(20), 
	gno nvarchar(1), 
	custno nvarchar(50), 
	total decimal(18,0), 
	salesno nvarchar(30)
) 

insert into @tmp (coin,gno,custno,salesno,total)
select @t_xcoin,'1',custno,salesno,SUM(money) from (
	--trd
	--select aa.custno,bb.salesno,SUM(isnull(unpay,0)) money from view_trd aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end) < @t_bsmon
	--and len(@t_paytype)=0
	--group by  aa.custno,bb.salesno
	--union all
	--vcc
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	--,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,6)<@t_bsmon and left(vccno,len(vccno)-7)=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) money
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay*coin.floata,0))
	-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ub.custno+'-'+ub.paymon=ub.vccno and (ub.paymon<@t_bmon ) and ub.custno=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0)*coin.floata money 
	from view_vcc aa left join cust bb on aa.custno=bb.noa 
	outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and aa.datea <=edate order by edate desc,noa desc),1) floata) coin 
	where ((case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end) < @t_bmon) and (left(isnull(kind,''),4)!='健勞勞退')
	and (len(@t_cno)=0 or aa.cno=@t_cno)
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end),coin.floata
	having SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay*coin.floata,0))	-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ub.custno+'-'+ub.paymon=ub.vccno and (ub.paymon<@t_bmon ) and ub.custno=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0)*coin.floata!=0
	--vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	--,SUM(isnull(ca.tax,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)='-TAX' and left(right(vccno,10),6)<@t_bsmon and left(vccno,len(vccno)-11)=ca.custno),0)
	,SUM(isnull(ca.tax*coin.floata,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ca.noa=ub.vccno and (ub.paymon<@t_bmon ) and ub.custno=ca.custno),0) *coin.floata
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and ca.datea <=edate order by edate desc,noa desc),1) floata) coin 
	where ((case when ca.mon!='' then ca.mon else LEFT(ca.datea,6) end) < @t_bmon ) and ([21]!=3)
	and (ca.taxtype='1' or ca.taxtype='5') and (len(@t_cno)=0 or ca.cno=@t_cno)
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end),ca.noa,coin.floata
	having SUM(isnull(ca.tax*coin.floata,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ca.noa=ub.vccno and (ub.paymon<@t_bmon ) and ub.custno=ca.custno),0)*coin.floata !=0
	--union all
	--cara
	--select ca.carownerno,ca.sssno,outmoney-inmoney from cara ca left join caras cb on ca.noa=cb.noa where ca.mon=@t_bsmon and cb.caritemno='001'
	--and len(@t_paytype)=0
)tmp --where (custno between @t_bcustno and @t_ecustno ) and (salesno between @t_bsalesno and @t_esalesno) 
group by custno,salesno

delete @tmp where not((custno between @t_bcustno and @t_ecustno ) and (@t_multcust='' or CHARINDEX('.'+custno+'.',@t_multcust)>0) and (salesno between @t_bsalesno and @t_esalesno)) 

-----end 前期----------------------------------------------------------------------------------

--update a
--	set unpay=isnull((select total1-pay from @tmp where custno=a.custno and coin=a.coin and gno='1'),0)
--from #result a where a.gno='1'

--insert into #result (coin,gno,noa,noq,datea,mon,custno,comp,salesno,saless,total1,pay,unpay)
--select coin,gno,noa,noq,datea,mon,custno,comp,salesno,saless,0,0,total1-pay+unpay from @tmp
--where custno not in (select custno from #result) and gno='1' and (total1-pay+unpay)!=0

update a 
set unpay=isnull((select sum(total) from @tmp where custno=a.custno and coin=a.coin and gno='1'),0) 
from #result a where a.gno='1' 

--insert into #result (coin,gno,noa,noq,datea,mon,custno,comp,salesno,saless,total1,pay,unpay) 
--select coin,gno,'','','','',a.custno,b.comp,a.salesno,c.namea,0,0,total from @tmp a 
--left join cust b on a.custno=b.noa left join sss c on a.salesno=c.noa
--where custno not in (select custno from #result) and gno='1' and total!=0 

insert into #result (coin,gno,noa,noq,datea,mon,custno,comp,salesno,saless,total1,pay,unpay) 
select coin,gno,'','','','',a.custno,b.comp,'','',0,0,sum(total) from @tmp a 
left join cust b on a.custno=b.noa 
where custno not in (select custno from #result) and gno='1' and total!=0 
group by coin,gno,a.custno,b.comp

update #result
set salesno=(select top 1 (case when salesno2!='' then salesno2 else salesno end) from view_vcc order by datea desc )
,saless=(select top 1 (case when salesno2!='' then sales2 else sales end) from view_vcc order by datea desc )
where salesno=''

update #result
	set total2=total1+unpay-pay
where gno='1'

--當本期區間內沒有未收就不顯示
if(@t_showunpay='1')
delete #result where custno in (select custno from #result where gno='1' and total2=0)

if(@t_xcoin='ALL')
begin
	update #result set coin='' where coin=@t_xcoin
	update @tmp set coin='' where coin=@t_xcoin
end

delete #result where datea not between @t_bdate and @t_edate and (gno='0' or gno='2')

select
	gno,typea,noa,noq,datea,mon,custno,replace(comp,'~#$',char(39)) comp,addr_invo,tel,productno,replace(xproduct,'~#$',char(39)) xproduct,unit
	,(select top 1 saless from #result where custno=a.custno and saless!='' order by datea desc)saless
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),0,30)) mount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,weight),1)),0,30)) weight
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),0,30)) price
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),(case when coin!='' then 0 else 4 end),30)) total
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,money),1)),(case when coin!='' then 0 else 4 end),30)) money
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,back),1)),(case when coin!='' then 0 else 4 end),30)) back
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,tax),1)),(case when coin!='' then 0 else 4 end),30)) tax
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total1),1)),(case when coin!='' then 0 else 4 end),30)) total1
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,pay),1)),(case when coin!='' then 0 else 4 end),30)) pay
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unpay),1)),(case when coin!='' then 0 else 4 end),30)) unpay
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total2),1)),(case when coin!='' then 0 else 4 end),30)) total2
	,pcount,case when coin!='' then '_'+coin else '' end coin 
from #result a order by custno,coin,case when gno='2' then '0' else gno end,mon,datea,noa,noq

IF OBJECT_ID('tempdb..#result')is not null
BEGIN
	set @cmd = 'drop table #result'
	EXECUTE sp_executesql @cmd
END
;
--**************************************************************************************************
z_umm11:--z_umm11
declare @t_pageline int = 16   --------一頁幾行
declare @t_bcustno nvarchar(50)
declare @t_ecustno nvarchar(50)
declare @t_bmon nvarchar(20)
declare @t_emon nvarchar(20)
set @t_bmon = case when '#non'=[13] then '' else [13] end
set @t_emon = case when '#non'=[14] then char(255) else [14] end
set @t_bcustno = case when '#non'=[5] then '' else [5] end
set @t_ecustno = case when '#non'=[6] then char(255) else [6] end
declare @tmp table(
	gno nvarchar(1),
	idno int identity(0,1),
	orderno int,
	pageno int,
	typea nvarchar(10),
	custno nvarchar(50),
	custs nvarchar(90),
	zipcode nvarchar(90),
	addr nvarchar(max),
	tel nvarchar(max),
	datea nvarchar(20),
	noa nvarchar(30),
	pno nvarchar(30),
	products nvarchar(90),
	csize nvarchar(max),
	b_mount float,
	b_price float,
	b_money float,
	b_tax float,
	b_total float,
	a_total float,
	t_total1 float,
	t_total2 float,
	t_total3 float,
	t_total4 float,
	t_total5 float,
	t_total6 float,
	t_total7 float,
	t_total8 float,
	t_total9 float
)

insert into @tmp
	select
		 '0',ROW_NUMBER()over(partition by a.custno,a.comp,c.zip_home,c.addr_home order by a.custno,a.comp,c.zip_home,c.addr_home),1,
		 (case a.typea when '1' then '出' when '2' then '退' end),a.custno,a.comp,c.zip_home,c.addr_home,a.tel,right(a.datea,5),a.noa,
		 b.productno,b.product,
		 (case when ltrim(rtrim(isnull(b.size,'')))='' then dbo.csize(a.kind,b.dime,b.width,b.lengthb,b.radius) else b.size end),
		 b.mount,b.price,b.total,a.tax,0,a.total,0,0,0,isnull((isnull(d.total,0)+isnull(d.tax,0)),0),0,0,0,0,0
	from view_vcc a
	left join view_vccs b on (a.noa = b.noa)
	left join cust c on a.custno = c.noa
	left join vccbs d on a.invono = d.invono
	left join vccb e on (d.noa = e.noa) and (e.typea = '2'/*銷貨折讓*/)
	where (a.custno between @t_bcustno and @t_ecustno) and (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end between @t_bmon and @t_emon)
update @tmp set datea = isnull(typea,'') + isnull(datea,'')

declare @a_count int
declare @idno int
declare @k int = 0 ----差幾頁
declare @pageCount int
declare @orderno int
declare @pageno int
declare @custno nvarchar(50)
declare @custs nvarchar(90)
declare @zipcode nvarchar(20)
declare @addr nvarchar(max)
declare @tel nvarchar(90)
declare cursor_table cursor for
	select custno,custs,count(*),max(orderno) from @tmp group by custno,custs
open cursor_table
fetch next from cursor_table
into @custno,@custs,@a_count,@orderno
while(@@FETCH_STATUS <> -1)
begin
	if(@a_count > @t_pageline)
	begin
		set @k = CEILING((cast(@a_count as float)/@t_pageline))
		while(@k > 0)
		begin
			update @tmp set pageno = @k where orderno > ((@k-1)*@t_pageline) and orderno <= (@k*@t_pageline)
			set @k -=1
		end
	end
	fetch next from cursor_table
	into @custno,@custs,@a_count,@orderno
end
close cursor_table
deallocate cursor_table
update @tmp set orderno = orderno-((pageno-1)*@t_pageline)

declare @noa nvarchar(30)
declare @b_tax float
declare @t_total4 float
declare @b_total float
---------整理BBM資料--------------------------------------------------------------
declare cursor_table cursor for
	select distinct noa,idno,b_tax,t_total4,a_total from @tmp order by noa
open cursor_table
fetch next from cursor_table
into @noa,@idno,@b_tax,@t_total4,@b_total
while(@@FETCH_STATUS <> -1)
begin
	update @tmp set b_tax = 0 where noa = @noa
	update @tmp set b_tax = @b_tax where (noa = @noa) and (idno = @idno)
	update @tmp set b_total = 0 where noa = @noa
	update @tmp set b_total = @b_total where (noa = @noa) and (idno = @idno)
	update @tmp set t_total4 = 0 where noa = @noa
	update @tmp set t_total4 = @t_total4 where (noa = @noa) and (idno = @idno)
	fetch next from cursor_table
	into @noa,@idno,@b_tax,@t_total4,@b_total
end
close cursor_table
deallocate cursor_table
------------------------------------------------------------------------------
declare cursor_table cursor for
	select distinct custno,max(custs),max(zipcode),max(addr),max(tel),max(orderno),pageno,min(idno),count(*) from @tmp group by custno,custs,zipcode,addr,tel,pageno
open cursor_table
fetch next from cursor_table
into @custno,@custs,@zipcode,@addr,@tel,@orderno,@pageno,@idno,@a_count
while(@@FETCH_STATUS <> -1)
begin
	set @k = @t_pageline -(@a_count%@t_pageline)
	set @pageCount = @a_count/@t_pageline
	if(@k < @t_pageline and (@pageCount =0))
	begin
		while(@k > 0)
		begin
			insert into @tmp(gno,orderno,pageno,custno,custs,zipcode,addr,tel)
				select '0',(@orderno+1),@pageno,@custno,@custs,@zipcode,@addr,@tel from @tmp where idno = @idno
			set @k = @k-1
			set @orderno = @orderno +1
		end
	end
	insert into @tmp(gno,orderno,pageno,custno,custs,zipcode,addr,tel,t_total1,t_total2,t_total4)
		select '1',(@t_pageline+1),pageno,@custno,@custs,@zipcode,@addr,@tel,sum(b_money),sum(b_tax),sum(t_total4) from @tmp where gno=0 and (isnull(custno,'')=isnull(@custno,'')) and (isnull(custs,'')=isnull(@custs,'')) and (isnull(zipcode,'')=isnull(@zipcode,''))  and (isnull(addr,'')=isnull(@addr,'')) and (pageno=@pageno) group by custno,custs,zipcode,addr,pageno
	insert into @tmp(gno,orderno,pageno,custno,custs,zipcode,addr,tel)
		select '2',(@t_pageline+2),pageno,@custno,@custs,@zipcode,@addr,@tel from @tmp where gno=0 and (isnull(custno,'')=isnull(@custno,'')) and (isnull(custs,'')=isnull(@custs,'')) and (isnull(zipcode,'')=isnull(@zipcode,''))  and (isnull(addr,'')=isnull(@addr,'')) and pageno=@pageno group by pageno
	fetch next from cursor_table
	into @custno,@custs,@zipcode,@addr,@tel,@orderno,@pageno,@idno,@a_count
end
close cursor_table
deallocate cursor_table
update @tmp set t_total3 = isnull((isnull(t_total1,0) + isnull(t_total2,0)),0) where gno = '1'
update @tmp set t_total6 = isnull((isnull(t_total3,0) - isnull(t_total4,0) - isnull(t_total5,0)),0) where gno = '1'
update @tmp set t_total9 = isnull((isnull(t_total6,0) + isnull(t_total8,0) - isnull(t_total7,0)),0) where gno = '1'
update @tmp set t_total9 = 0 where gno = '1' and (t_total9 <=0)
update @tmp set csize = replace(csize,'~#$','''')
select
	gno,idno,orderno,pageno,typea,custno,custs,zipcode,addr,tel,datea a1,left(noa,7) noa,pno,products a2,csize,
	b_mount,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(b_price)),1)),4,12))+'.'+LEFT(CAST((cast(floor((b_price*1000)-(floor(b_price)*1000)) as nvarchar)) as NVARCHAR) + REPLICATE('0', 3), 3) b_price,
	b_money,
	(case when b_tax = 0 then null else b_tax end) b_tax,
	(case when b_total = 0 then null else b_total end) b_total,
	isnull(t_total1,0) t_total1,
	isnull(t_total2,0) t_total2,
	isnull(t_total3,0) t_total3,
	isnull(t_total4,0) t_total4,
	isnull(t_total5,0) t_total5,
	isnull(t_total6,0) t_total6,
	isnull(t_total7,0) t_total7,
	isnull(t_total8,0) t_total8,
	isnull(t_total9,0) t_total9
from @tmp order by custno,custs,zipcode,addr,pageno,gno,orderno;

--********************************************************************************
z_umm12:--z_umm12
declare @t_bcustno nvarchar(50)
declare @t_ecustno nvarchar(50)
declare @t_bsmon nvarchar(10)
declare @t_esmon nvarchar(10)
declare @t_bsalesno nvarchar(10)
declare @t_esalesno nvarchar(10)
declare @t_xaccy nvarchar(20)
declare @t_paytype nvarchar(MAX)

set @t_xaccy = '[10]'
set @t_bcustno = case when '#non' = [5] then '' else [5] end
set @t_ecustno = case when '#non' = [6] then CHAR(255) else [6] end
set @t_bsmon = case when '#non' = [13] then '' else [13] end
set @t_esmon = case when '#non' = [14] then CHAR(255) else [14] end
set @t_bsalesno = case when '#non' = [15] then '' else [15] end
set @t_esalesno = case when '#non' = [16] then CHAR(255) else [16] end
set @t_paytype = case when '#non' = [20] then '' else [20] end
-------------------------------------------------------------------------------
SET QUOTED_IDENTIFIER OFF
declare @cmd nvarchar(max)
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END

create table #tmp(
	gno nvarchar(1),
	custno nvarchar(50),
	comp nvarchar(MAX),
	salesno nvarchar(30),
	namea nvarchar(30),
	mon nvarchar(10),
	money float,
	total float,
	payed float,
	unpay float
)

--前期
insert into #tmp (gno,mon,custno,salesno,money,total,payed)
select '9',mon,custno,salesno,SUM(money),0,0 from (
	--vcc
	select aa.mon,(case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ub.custno+'-'+ub.paymon=ub.vccno and ub.paymon<@t_bsmon and ub.custno=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) money 
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end) < @t_bsmon and (left(isnull(kind,''),4)!='健勞勞退')
	and (len(@t_paytype)=0 or aa.paytype=@t_paytype)
	group by aa.mon,(case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	having SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ub.custno+'-'+ub.paymon=ub.vccno and ub.paymon<@t_bsmon and ub.custno=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0)!=0
	--vcca
	union all
	select ca.mon,ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,SUM(isnull(ca.tax,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ca.noa=ub.vccno and ub.paymon<@t_bsmon and ub.custno=ca.custno),0) 
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,6) end) < @t_bsmon and ([21]!=3)
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.mon,ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end),ca.noa
	having SUM(isnull(ca.tax,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ca.noa=ub.vccno and ub.paymon<@t_bsmon and ub.custno=ca.custno),0) !=0
)tmp where (custno between @t_bcustno and @t_ecustno ) and (salesno between @t_bsalesno and @t_esalesno) 
group by mon,custno,salesno

--本期
insert into #tmp (gno,mon,custno,salesno,money,total,payed)
select '9',mon,custno,salesno,0,SUM(total),0 from (
	--vcc
	select aa.mon,(case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*total,0)) total
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end) between @t_bsmon and @t_esmon and (left(isnull(kind,''),4)!='健勞勞退')
	and (len(@t_paytype)=0 or aa.paytype=@t_paytype)
	group by aa.mon,(case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	--vcca
	union all
	select ca.mon,ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,SUM(isnull(ca.tax,0))
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,6) end) between @t_bsmon and @t_esmon
	and (ca.taxtype='1' or ca.taxtype='5') and ([21]!=3)
	group by ca.mon,ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end)
)tmp where (custno between @t_bcustno and @t_ecustno ) and (salesno between @t_bsalesno and @t_esalesno) 
group by mon,custno,salesno

--本期已付
insert into #tmp (gno,mon,custno,salesno,money,total,payed)
select '9',mon,custno,salesno,0,0,SUM(payed) from (
	--vcc
	select aa.mon,(case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*payed,0))
	+isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ub.vccno=ub.custno+'-'+ub.paymon and ub.paymon between @t_bsmon and @t_esmon and ub.custno=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) payed 
	from view_vcc aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end) between @t_bsmon and @t_esmon and (left(isnull(kind,''),4)!='健勞勞退')
	and (len(@t_paytype)=0 or aa.paytype=@t_paytype)
	group by aa.mon,(case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	--vcca
	union all
	select ca.mon,ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	,0+isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ca.noa=ub.vccno and  ub.paymon between @t_bsmon and @t_esmon and ub.custno=ca.custno),0) 
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where (case when ca.mon!='' then ca.mon else LEFT(ca.datea,6) end) between @t_bsmon and @t_esmon
	and (ca.taxtype='1' or ca.taxtype='5') and ([21]!=3)
	group by ca.mon,ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end),ca.noa 
)tmp where (custno between @t_bcustno and @t_ecustno ) and (salesno between @t_bsalesno and @t_esalesno) 
group by mon,custno,salesno

--加總
insert into #tmp (gno,mon,custno,salesno,money,total,payed)
select '0',mon,custno,salesno,SUM(money),SUM(total),SUM(payed) from #tmp 
group by mon,custno,salesno

delete #tmp where money=0 and total=0 and payed=0

delete #tmp where gno='9'

--插入本期有的資料,最小未收月份
insert #tmp (gno,mon,custno,salesno,money,total,payed)
select '1',MIN(mon),custno,salesno,0,SUM(total),sum(payed)
from #tmp where gno='0'
group by custno,salesno

--插入沒有本期金額最小月份的未收金額
insert #tmp (gno,mon,custno,salesno,money,total,payed)
select '1',MIN(mon),custno,salesno,0,0,0
from #tmp a 
where gno='0' and not exists (select * from #tmp where gno='1' and custno=a.custno and salesno=a.salesno)
group by custno,salesno

--更新最小未收月份金額
update a
set money=isnull((select money from #tmp where gno='0' and mon=a.mon and custno=a.custno and salesno=a.salesno),0)
from #tmp a where gno='1'

--插入其他未收金額
insert #tmp (gno,mon,custno,salesno,money,total,payed,unpay)
select '2',mon,custno,salesno,money,total,payed,0
from #tmp a 
where gno='0' and not exists (select * from #tmp where gno='1' and custno=a.custno and salesno=a.salesno and mon=a.mon)
and mon not between @t_bsmon and @t_esmon

delete #tmp where gno='0'

update a
set unpay=(select sum(isnull(money,0)+isnull(total,0)-isnull(payed,0)) from #tmp where salesno=a.salesno and custno=a.custno)
from #tmp a
where gno='1'

update #tmp
set comp=(select top 1 nick from ((select nick from cust where noa=custno union select namea from carOwner where noa=custno union select namea from sss where noa=custno))tmp)
,namea=isnull((select namea from sss where noa=salesno),'')

insert into #tmp
select '3'gno,CHAR(255),'',salesno,'',CHAR(255),sum(money),sum(total),sum(payed),SUM(unpay) from #tmp group by salesno

select gno,custno,replace(comp,'~#$',char(39)) comp,salesno saleno,namea sales,mon
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,money),1)),4,30)) money
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),4,30)) total
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,payed),1)),4,30)) payed
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unpay),1)),4,30)) unpay
from #tmp order by salesno,custno,gno,mon

IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END
;
--********************************************************************************
z_umm13:--z_umm13
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bmon nvarchar(7)
declare @t_emon nvarchar(7)
declare @t_bcustno nvarchar(50)
declare @t_ecustno nvarchar(50)
declare @t_bsalesno nvarchar(20)
declare @t_esalesno nvarchar(20)
declare @t_showunpay nvarchar(30)
declare @t_bcusttype nvarchar(50)
declare @t_ecusttype nvarchar(50)
set @t_bdate = case when '#non'=[3] then '' else [3] end
set @t_edate = case when '#non'=[4] then char(255) else [4] end
set @t_bmon = case when '#non'=[13] then '' else [13] end
set @t_emon = case when '#non'=[14] then char(255) else [14] end
set @t_bcustno = case when '#non'=[5] then '' else [5] end
set @t_ecustno = case when '#non'=[6] then char(255) else [6] end
set @t_bsalesno = case when '#non'=[15] then '' else [15] end
set @t_esalesno = case when '#non'=[16] then char(255) else [16] end
set @t_showunpay = case when '#non'=[22] then '0' else [22] end
set @t_bcusttype = case when '#non'=[23] then '' else [23] end
set @t_ecusttype = case when '#non'=[24] then char(255) else [24] end
-------------------------------------------------------------------------------------------------------------
declare @cmd nvarchar(max)
IF OBJECT_ID('tempdb..#result')is not null
BEGIN
	set @cmd = 'drop table #result'
	EXECUTE sp_executesql @cmd
END

create table #result(
	gno nvarchar(10),
	idno int identity(0,1),
	pageno int,
	totpage int,
	orderno int,
	typea nvarchar(20),
	noa nvarchar(50),
	invoiceno nvarchar(max),
	datea nvarchar(10),
	mon nvarchar(7),
	custno nvarchar(50),
	comp nvarchar(MAX),
	addr_invo nvarchar(max),
	serial nvarchar(90),
	tel nvarchar(90),
	total float,
	money float,
	back float,
	tax float,
	total1 float,
	pay float,
	unpay float,
	total2 float,
	salesno nvarchar(30),
	saless nvarchar(30),
	form nvarchar(90),
	memo nvarchar(max),--104/10
	fax nvarchar(90)--104/10
)

--if(@t_showunpay='0')
if(CHARINDEX('1',@t_showunpay)=0)
begin
	insert into #result
		select '0' gno,0 pageno,0 totpage,0 orderno, a.typea, a.noa noa,isnull(a.invono,'') invoiceno, a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
			   (case when isnull(a.custno2,'')!='' then isnull(a.custno2,'') else a.custno end) custno, '', '','','',
		       sum(b.total) total, 0 money, 0 back, 0 tax, 0 total1,payed,unpay, 0 total2
		       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno 
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
		       ,'vcc','',''
		from view_vccs b
		left join view_vcc a on a.noa = b.noa
		left join cust c on  (case when a.custno2!='' then a.custno2 else a.custno end) = c.noa
		where --(a.datea between @t_bdate and @t_edate) and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ((case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
		group by a.typea, a.noa,a.invono,a.datea,a.mon,a.custno2,a.custno
		,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) 
		,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end) 
		,payed,unpay
		union all --無發票系統
		select '0' gno,0 pageno,0 totpage,0 orderno, '稅' typea, a.noa,a.invono, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   (case when a.custno2!='' then a.custno2 else a.custno end), '' comp, '' addr_invo,'' serial, '' tel,
			   0 total, 0 money, 0 back, (case when a.typea!='1' then -1 else 1 end) *a.tax tax, 0 total1, 0 pay, 0 unpay, 0 total2
			   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno 
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
			   ,'vcc','',''
		from view_vcc a
		left join cust c on  (case when a.custno2!='' then a.custno2 else a.custno end) = c.noa
		where tax > 0 and (a.taxtype='1' or a.taxtype='5') and
			  --(a.datea between @t_bdate and @t_edate) and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ( (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
		union all --有發票系統
		select '0' gno,0 pageno,0 totpage,0 orderno, '稅' typea, a.vccno,a.noa, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   a.custno, '' comp, '' addr_invo,'' serial, '' tel,
			   0 total, 0 money, 0 back, a.tax, 0 total1, 0 pay, 0 unpay, 0 total2,c.salesno,c.sales
			   ,'vcca','',''
		from vcca a left join cust c on a.custno=c.noa
		where a.tax > 0 and (a.taxtype='1' or a.taxtype='5') and ([21]!=3) and
				--(a.datea between @t_bdate and @t_edate) and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  (a.custno between @t_bcustno and @t_ecustno) and 
			  (c.salesno between @t_bsalesno and @t_esalesno)
		order by custno,gno,mon,datea,noa
end
--else
if(CHARINDEX('1',@t_showunpay)>0)
begin
	insert into #result
	select '0' gno,0 pageno,0 totpage,0 orderno, a.typea, a.noa noa,isnull(a.invono,''), a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
			   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) custno, '', '','', '',
		       sum(b.total) total, 0 money, 0 back, 0 tax, 0 total1,payed,unpay, 0 total2
		       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno 
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
		       ,'vcc','',''
		from view_vccs b
		left join view_vcc a on a.noa = b.noa
		left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
		where --(a.datea between @t_bdate and @t_edate) and 
			a.unpay>0 and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ((case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
		group by a.typea, a.noa,a.invono,a.datea,a.mon,a.custno2,a.custno
		,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) 
		,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end) 
		,payed,unpay
		union all --無發票系統
		select '0' gno,0 pageno,0 totpage,0 orderno, '稅' typea, a.noa,a.invono, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end), '' comp, '' addr_invo,'' serial, '' tel,
			   0 total, 0 money, 0 back, (case when a.typea!='1' then -1 else 1 end) *a.tax tax, 0 total1, 0 pay, 0 unpay, 0 total2
			   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno 
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
			   ,'vcc','',''
		from view_vcc a
		left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
		where tax > 0 and (a.taxtype='1' or a.taxtype='5') and
			  --(a.datea between @t_bdate and @t_edate) and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ( (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
		union all --有發票系統
		select '0' gno,0 pageno,0 totpage,0 orderno, '稅' typea, a.vccno,a.noa, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   a.custno, '' comp, '' addr_invo,'' serial, '' tel,
			   0 total, 0 money, 0 back, a.tax, 0 total1, 0 pay, 0 unpay, 0 total2,c.salesno,c.sales
			   ,'vcca','',''
		from vcca a 
		left join cust c on  a.custno = c.noa
		where tax > 0 and (a.taxtype='1' or a.taxtype='5') and ([21]!=3) and
				--(a.datea between @t_bdate and @t_edate) and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  (a.custno between @t_bcustno and @t_ecustno) and 
			  (c.salesno between @t_bsalesno and @t_esalesno)
		order by custno,gno,mon,datea,noa
end

delete #result where custno not in (select distinct noa from cust where isnull(typea,'') between @t_bcusttype and @t_ecusttype)

update a 
set tax=isnull((select sum(tax) tax from #result where noa=a.noa and (typea='稅')),0)
,comp=isnull(c.comp,''),addr_invo=isnull(c.addr_invo,''),serial=isnull(c.serial,''),tel=isnull(c.tel,'') 
from #result a left join cust c on a.custno = c.noa 
where isnull(a.noa,'')!='' and (a.typea!='稅')

delete #result where (typea='稅') and isnull(noa,'')!=''

declare @gno nvarchar(10)
declare @typea nvarchar(20)
declare @noa nvarchar(50)
declare @total float
declare @tax float
declare @mon nvarchar(7)
declare @custno nvarchar(50)
declare @comp nvarchar(max)
declare @t_custno nvarchar(50)
declare @t_comp nvarchar(max)
declare @t_money float
declare @t_back float
declare @t_tax float
declare @t_total1 float
declare @t_pay float
declare @t_unpay float
declare @t_total2 float
declare @salesno nvarchar(30) =''
declare @sales nvarchar(30) =''
declare @t_addr_invo nvarchar(max)
declare @t_serial nvarchar(max)
declare @t_tel nvarchar(max)
declare @addr_invo nvarchar(max)
declare @serial nvarchar(max)
declare @tel nvarchar(max)

set @t_custno = '#zzzz#zzzz'
set @t_comp = ''
set @t_money = 0
set @t_back = 0
set @t_tax = 0
set @t_total1 = 0
set @t_pay = 0
set @t_unpay = 0
set @t_total2 = 0

insert #result
select '1' gno,0 pageno,0 totpage,0 orderno, '' typea, '' noa,'' invoiceno, '' datea, '' mon, custno, MAX(comp) comp
		,MAX(addr_invo) addr_invo,MAX(serial) serial, MAX(tel) tel,0 total
		,SUM(case when typea = '1' then total else -1*total end),0 --後面退貨金額拿掉 所以直接加總
		--,SUM(case when typea = '1' then total else 0 end), sum(case when typea = '2' then total else 0 end)
		--,SUM(case when typea = '稅' then total else 0 end),0
		,sum(tax),0
		,isnull((select sum(ub.paysale) from umms ub where ub.vccno in (select noa from #result where gno='0' and custno=a.custno)),0) --單據
		+isnull((select sum(ub.paysale) from umms ub where (ub.custno+'-'+ub.paymon=ub.vccno 
		and (ub.paymon between @t_bmon and @t_emon) and (ub.paymon+'/01' between @t_bdate and @t_edate) 
		and ub.custno=a.custno)),0) --月結 
		pay, 0 unpay, 0 total2,'','','','',''  from #result a group by custno
		
update #result set total1=money-back+tax where gno='1'
	
--update #result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

declare @tmp table( 
	coin nvarchar(20), 
	gno nvarchar(1), 
	custno nvarchar(50), 
	total decimal(18,0), 
	salesno nvarchar(30)
) 

insert into @tmp (gno,custno,salesno,total)
select '1',custno,salesno,SUM(money) from (
	--trd
	--select aa.custno,bb.salesno,SUM(isnull(unpay,0)) money from view_trd aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end) < @t_bsmon
	--and len(@t_paytype)=0
	--group by  aa.custno,bb.salesno
	--union all
	--vcc
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	--,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,6)<@t_bsmon and left(vccno,len(vccno)-7)=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) money
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay,0))
	-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ub.custno+'-'+ub.paymon=ub.vccno and (ub.paymon<@t_bmon) and ub.custno=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) money 
	from view_vcc aa left join cust bb on aa.custno=bb.noa 
	where ((case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end) < @t_bmon ) and (left(isnull(kind,''),4)!='健勞勞退')
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end)
	having SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay,0))	-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ub.custno+'-'+ub.paymon=ub.vccno and (ub.paymon<@t_bmon ) and ub.custno=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0)!=0
	--vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	--,SUM(isnull(ca.tax,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)='-TAX' and left(right(vccno,10),6)<@t_bsmon and left(vccno,len(vccno)-11)=ca.custno),0)
	,SUM(isnull(ca.tax,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ca.noa=ub.vccno and (ub.paymon<@t_bmon ) and ub.custno=ca.custno),0) 
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	where ((case when ca.mon!='' then ca.mon else LEFT(ca.datea,6) end) < @t_bmon ) and ([21]!=3)
	and (ca.taxtype='1' or ca.taxtype='5')
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end),ca.noa
	having SUM(isnull(ca.tax,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ca.noa=ub.vccno and (ub.paymon<@t_bmon ) and ub.custno=ca.custno),0) !=0
	--union all
	--cara
	--select ca.carownerno,ca.sssno,outmoney-inmoney from cara ca left join caras cb on ca.noa=cb.noa where ca.mon=@t_bsmon and cb.caritemno='001'
	--and len(@t_paytype)=0
)tmp --where (custno between @t_bcustno and @t_ecustno ) and (salesno between @t_bsalesno and @t_esalesno) 
group by custno,salesno

delete @tmp where not((custno between @t_bcustno and @t_ecustno ) and (salesno between @t_bsalesno and @t_esalesno)) 
-----end 前期----------------------------------------------------------------------------------
update a 
set unpay=isnull((select sum(total) from @tmp where custno=a.custno and gno='1'),0) 
from #result a where a.gno='1' 

insert into #result (gno,noa,datea,mon,custno,comp,salesno,saless,total1,pay,unpay) 
select gno,'','','',a.custno,b.comp,a.salesno,c.namea,0,0,total from @tmp a 
left join cust b on a.custno=b.noa left join sss c on a.salesno=c.noa
--where custno not in (select custno from #result) and gno='1' and total!=0 
where  not exists (select custno from #result where custno=a.custno) and gno='1' and total!=0

update #result set total1=total,total2=case when typea = '1' then 1 else -1 end*total+tax where gno='0'
update #result set total2=total1+unpay-pay where gno='1'
update #result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

--當本期區間內沒有未收就不顯示
if(@t_showunpay='1')
	delete a from #result a where exists (select distinct custno from #result where custno=a.custno and gno='1' and total2=0) 
	--delete #result where custno in (select distinct custno from #result where gno='1' and total2=0)
--插入前期帳款
--insert #result(gno,typea,noa,mon,datea,total1,tax,total2,unpay,form,custno,comp,addr_invo,serial,tel,salesno,saless)
--select '0','出','前期帳款',@t_bmon,@t_bdate,0,0,0,total1-pay,'vcc',custno,comp,addr_invo,serial,tel,salesno,saless
--from @tmp where gno='1' and custno in (select custno from #result group by custno)

insert #result(gno,typea,noa,mon,datea,total1,tax,total2,unpay,form,custno,comp,addr_invo,serial,tel,salesno,saless) 
select '0','出','前期帳款'+(case when (select count(*) from @tmp where custno=a.custno)>1 then '-'+a.salesno else '' end)
,@t_bmon,@t_bdate,0,0,0,total,'vcc',custno,b.comp,addr_invo,serial,b.tel,a.salesno,c.namea
from @tmp a left join cust b on a.custno=b.noa left join sss c on a.salesno=c.noa where gno='1'
and exists (select custno from #result where custno=a.custno group by custno)  
--and custno in (select custno from #result group by custno) 

insert #result (gno,noa,datea,mon,custno,comp,money,tax,total1,pay,unpay,total2,salesno)
select '3','','','',custno,comp,SUM(money),sum(tax),SUM(total1),SUM(pay),SUM(unpay),SUM(total2),'' 
from #result where gno='1' group by custno,comp

--預收
update a
set pay=isnull((select SUM( opay - unopay) total from umm where custno=a.custno),0)
from #result a where gno='3'

delete #result where gno='1'
----------------------------------------------------
--貨單備註
if(CHARINDEX('2',@t_showunpay)>0)
begin
	update #result set memo=b.memo 
		from #result a
		left join (
			select noa,memo
			from view_vcc
		)b on a.noa=b.noa 
	
	declare @memo nvarchar(max)
	declare @idno int
	declare @line int --memo的換行數
	declare @i    int

	declare cursor_table cursor for
	select idno,memo from #result where gno = '0' and LEN(memo)>0
	open cursor_table
	fetch next from cursor_table
	into @idno,@memo
	while(@@FETCH_STATUS <> -1)
	begin
		set @line = (LEN(@memo)-LEN(REPLACE(@memo,'chr(10)','')))/7
	
		set @i = 0
		while(@i<=@line)
		begin
			insert into #result(gno,custno,noa,datea,memo)
			select '4',custno,noa,datea,dbo.split(@memo,'chr(10)',@i) from #result where memo = @memo and idno = @idno
			
			set @i = @i + 1
		end
		
		fetch next from cursor_table
		into @idno,@memo
	end
	close cursor_table
	deallocate cursor_table
end
delete #result where gno='4' and LEN(memo)=0
delete #result where (gno='0' or gno='4') and datea not between @t_bdate and @t_edate

----------------------------------------------------
declare @pageCount int = 12 --一頁含合計共幾行
declare @totalLineCount int = 5 --合計有幾行
----------------------------------------------------
------>>頁數處理 gno='1' 空白行 gno='2' 跳頁 gno='3' 合計

declare @nowOrder int = 0
declare @thisPageno int = 0
set @t_custno = '#zzzz#zzzz'
declare cursor_table cursor for
	select idno,gno,custno from #result where gno != '3' order by custno,case when noa like '前期帳款%' then '' else noa end,gno,datea
open cursor_table
fetch next from cursor_table
into @idno,@gno,@custno
while(@@FETCH_STATUS <> -1)
begin
	if(@t_custno != @custno)
	begin
		set @nowOrder = 1
		set @thisPageno = 1
		set @t_custno = @custno
	end
	else
	begin
		if(@nowOrder = (@pageCount))
		begin
			set @nowOrder = 1
			set @thisPageno = @thisPageno+1
		end
		else
		begin
			set @nowOrder = @nowOrder+1
		end
	end
	update #result set orderno=@nowOrder,pageno=@thisPageno where idno=@idno
	fetch next from cursor_table
	into @idno,@gno,@custno
end
close cursor_table
deallocate cursor_table

update a
	set totpage=b.maxpageno
from #result a
outer apply(select max(pageno) maxpageno from #result where a.custno=custno) b

update a
	set orderno=case when b.maxorderno>=@pageCount then 1 else b.maxorderno+1 end,
		pageno=case when b.maxorderno>=@pageCount then a.totpage+1 else a.totpage end,
		totpage=case when b.maxorderno>=@pageCount then a.totpage+1 else a.totpage end
from #result a
outer apply(select max(orderno) maxorderno from #result where a.custno=custno and (a.totpage=pageno)) b
where a.gno='3'

update #result set orderno=1,pageno=1,totpage=1 where gno=3 and orderno is null and pageno is null and totpage is null

declare @totpage int = 0
declare cursor_table cursor for
	select idno,custno,totpage from #result where gno = '3' order by custno
open cursor_table
fetch next from cursor_table
into @idno,@custno,@totpage
while(@@FETCH_STATUS <> -1)
begin
	declare @t_maxOrderno int = (select max(orderno) from #result where (custno=@custno) and (totpage=@totpage))
	if(@t_maxOrderno>(@pageCount-@totalLineCount))
	begin
		update #result set pageno=@totpage+1,totpage=@totpage+1 where (custno=@custno) and (pageno=@totpage) and ((orderno>@t_maxOrderno) or pageno=0)
	end
	declare @thisOrder int = (select top 1 orderno from #result where (custno=@custno) and (gno='3'))
	declare @allLine int = (select sum(case when gno='0' or gno='4'  then 1 when gno='3' then @totalLineCount end) from #result where custno=@custno)
	while((@allLine % @pageCount) != 0)
	begin
		insert into #result(gno,orderno,pageno,totpage,typea,noa,invoiceno,datea,mon,custno,comp,addr_invo,serial,tel,salesno,saless,form)
			select
				'1',@thisOrder orderno,pageno,totpage,'' typea,'' noa,'' invoiceno,'' datea,'' mon,custno,comp,addr_invo,serial,tel,salesno,saless,'Empty' + cast(@thisOrder as nvarchar)
			from #result where idno=@idno
		set @thisOrder = @thisOrder+1
		if(@thisOrder > @pageCount)
		begin
			set @thisOrder = 1
			update #result set pageno=pageno+1 where custno=@custno and gno='3'
		end
		set @allLine = @allLine+1
	end
	update #result set orderno=@thisOrder where custno=@custno and gno='3'
	fetch next from cursor_table
	into @idno,@custno,@totpage
end
close cursor_table
deallocate cursor_table

update a
	set totpage = b.maxpageno
from #result a
outer apply(select max(pageno) maxpageno from #result where a.custno=custno) b

insert into #result(gno,orderno,pageno,totpage,custno)
	select
		'2',max(orderno)+1,pageno,totpage,custno
	from #result
	where pageno != totpage
	group by custno,pageno,totpage

update #result set fax=b.fax
		from #result a
		left join (
			select noa,fax
			from cust
		)b on a.custno=b.noa 

select
	gno,idno,orderno,pageno,totpage,typea,noa,invoiceno,datea,mon,custno,replace(comp,'~#$',char(39)) comp,addr_invo,serial,tel
	,(select top 1 saless from #result where custno=a.custno and saless!='' order by datea desc) saless
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),4,30)) total
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,money),1)),4,30)) money
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,back),1)),4,30)) back
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,tax),1)),4,30)) tax
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,(case when typea !='出' and typea!='稅' and gno='0' then -1 else 1 end)*total1),1)),4,30)) total1
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,pay),1)),4,30)) pay
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,(case when typea !='出' and typea!='稅' and gno='0' then -1 else 1 end)*unpay),1)),4,30)) unpay
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,(case when typea !='出' and typea!='稅' and gno='0' then -1 else 1 end)*total2),1)),4,30)) total2
	,(select count(*) from #result where (gno='0') and (custno=a.custno)) pcount
	,memo,fax
from #result a

order by custno,totpage,pageno,orderno,mon,datea,case when noa='前期帳款' then '0' else noa end,idno


IF OBJECT_ID('tempdb..#result')is not null
BEGIN
	set @cmd = 'drop table #result'
	EXECUTE sp_executesql @cmd
END;
--********************************************************************************************
z_umm16:--z_umm16
declare @t_cno nvarchar(20)
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bmon nvarchar(7)
declare @t_emon nvarchar(7)
declare @t_bcustno nvarchar(50)
declare @t_ecustno nvarchar(50)
declare @t_bsalesno nvarchar(50)
declare @t_esalesno nvarchar(50)
declare @t_bproductno nvarchar(30)
declare @t_eproductno nvarchar(30)
declare @t_showunpay nvarchar(30)
declare @t_xcoin nvarchar(20)
declare @t_showordetotal nvarchar(30)

set @t_cno = case when '#non' = [1] then '' else [1] end
set @t_bdate = case when '#non'=[3] then '' else [3] end
set @t_edate = case when '#non'=[4] then char(255) else [4] end
set @t_bmon = case when '#non'=[13] then '' else [13] end
set @t_emon = case when '#non'=[14] then char(255) else [14] end
set @t_bcustno = case when '#non'=[5] then '' else [5] end
set @t_ecustno = case when '#non'=[6] then char(255) else [6] end
set @t_bsalesno = case when '#non'=[15] then '' else [15] end
set @t_esalesno = case when '#non'=[16] then char(255) else [16] end
set @t_bproductno = case when '#non'=[17] then '' else [17] end
set @t_eproductno = case when '#non'=[18] then char(255) else [18] end
set @t_showunpay = case when '#non'=[22] then '0' else [22] end
set @t_xcoin = case when '#non' = [27] then '' else [27] end
set @t_showordetotal = case when '#non'=[28] then '0' else [28] end
declare @t_project nvarchar(50)=case when '#non' = '[26]' then '' else '[26]' end
-------------------------------------------------------------------------------------------------------------------------
declare @coin nvarchar(20)

declare @result table(
	coin nvarchar(20),
	gno nvarchar(1),
	typea nvarchar(4),
	noa nvarchar(30),
	noq nvarchar(10),
	datea nvarchar(10),
	mon nvarchar(7),
	custno nvarchar(50),
	comp nvarchar(MAX),
	addr_invo nvarchar(90),
	tel nvarchar(90),
	productno nvarchar(MAX),
	xproduct nvarchar(MAX),
	unit nvarchar(8),
	mount decimal(16,4),
	weight decimal(16,4),
	price decimal(16,4),
	total decimal(18,0),
	money decimal(18,0),
	back decimal(18,0),
	tax decimal(18,0),
	total1 decimal(18,0),
	pay decimal(18,0),
	unpay decimal(18,0),
	total2 decimal(18,0),
	pcount int,
	salesno nvarchar(30),
	saless nvarchar(30)
	primary key (coin,custno,gno,mon,datea,noa,noq)
)

if(@t_showunpay='0')
begin
	insert into @result
		select @t_xcoin,'0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
			   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
		       b.mount, b.weight, b.price*coin.floata, b.total*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
		       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
		from view_vccs b
		left join view_vcc a on a.noa = b.noa
		left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
		where (a.datea between @t_bdate and @t_edate) and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ((case when a.custno2!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno) and
			  (b.productno between @t_bproductno and @t_eproductno) and (len(@t_cno)=0 or a.cno=@t_cno)
		union all --無發票系統
		select @t_xcoin,'0' gno, '稅' typea, a.noa, CHAR(255) noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
			   0 mount, 0 weight, 0 price, (case when a.typea!='1' then -1 else 1 end) * tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
			   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
		from view_vcc a
		left join cust c on (case when a.custno2!='' then a.custno2 else a.custno end) = c.noa 
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
		where tax > 0 and (taxtype='1' or taxtype='5') and
			  (a.datea between @t_bdate and @t_edate)and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ( (case when isnull(a.custno2,'') !='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
			  and (len(@t_cno)=0 or a.cno=@t_cno)
		union all --有發票系統
		select @t_xcoin,'0' gno, '稅' typea, a.noa, '' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   a.custno, '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
			   0 mount, 0 weight, 0 price, a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
			   ,c.salesno,c.sales
		from vcca a left join cust c on a.custno = c.noa
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin 
		where tax > 0 and (taxtype='1' or taxtype='5') and ([21]!=3) and
				(a.datea between @t_bdate and @t_edate)and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and
			  (isnull(c.salesno,'') between @t_bsalesno and @t_esalesno) and (len(@t_cno)=0 or a.cno=@t_cno)
			  
		union all --折讓--義橋
		select @t_xcoin,'0' gno, '折' typea, a.noa, '999' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '折讓' product, '' unit,
			   0 mount, 0 weight, 0 price, (case when a.typea!='1' then 1 else -1 end) * a.discount*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
			   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
		from view_vcc a
		left join cust c on (case when a.custno2!='' then a.custno2 else a.custno end) = c.noa 
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
		where a.discount > 0 and @t_project='YC' and
			  (a.datea between @t_bdate and @t_edate)and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ( (case when isnull(a.custno2,'') !='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
			  and (len(@t_cno)=0 or a.cno=@t_cno)
		order by custno,gno,mon,datea,noa,noq
end
else
begin
	insert into @result
	select @t_xcoin,'0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
			   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
		       b.mount, b.weight, b.price*coin.floata, b.total*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
		       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
		from view_vccs b
		left join view_vcc a on a.noa = b.noa
		left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
		where (a.datea between @t_bdate and @t_edate) and a.unpay>0 and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ((case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno) and
			  (b.productno between @t_bproductno and @t_eproductno) and (len(@t_cno)=0 or a.cno=@t_cno)
		union all --無發票系統
		select @t_xcoin,'0' gno, '稅' typea, a.noa, CHAR(255) noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   (case when a.custno2!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
			   0 mount, 0 weight, 0 price, (case when a.typea!='1' then -1 else 1 end) *a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
			   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
		from view_vcc a
		left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
		where tax > 0 and (a.taxtype='1' or a.taxtype='5') and
			  (a.datea between @t_bdate and @t_edate)and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ( (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
			  and (len(@t_cno)=0 or a.cno=@t_cno)
		union all --有發票系統
		select @t_xcoin,'0' gno, '稅' typea, a.noa, '' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   custno, '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
			   0 mount, 0 weight, 0 price, a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
			   ,c.salesno,c.sales
		from vcca a left join cust c on a.custno = c.noa
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin 
		where tax > 0 and (a.taxtype='1' or a.taxtype='5') and ([21]!=3) and
				(a.datea between @t_bdate and @t_edate)and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and 
			  (isnull(c.salesno,'') between @t_bsalesno and @t_esalesno) and (len(@t_cno)=0 or a.cno=@t_cno)
		
		union all --折讓--義橋
		select @t_xcoin,'0' gno, '折' typea, a.noa, '999' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
			   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '折讓' product, '' unit,
			   0 mount, 0 weight, 0 price, (case when a.typea!='1' then 1 else -1 end) * a.discount*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
			   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
		from view_vcc a
		left join cust c on (case when a.custno2!='' then a.custno2 else a.custno end) = c.noa 
		outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
		where a.discount > 0 and @t_project='YC' and
			  (a.datea between @t_bdate and @t_edate)and
			  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
			  ( (case when isnull(a.custno2,'') !='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
			  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
			  and (len(@t_cno)=0 or a.cno=@t_cno)
		order by custno,gno,mon,datea,noa,noq
end

if(@t_xcoin='ALL')
begin
	declare cursor_table cursor for
	select coin from flors group by coin
	open cursor_table
	fetch next from cursor_table
	into @coin
	while(@@FETCH_STATUS <> -1)
	begin
		
		if(@t_showunpay='0')
		begin
			insert into @result
				select @coin,'0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
					   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
				       b.mount, b.weight, b.price*coin.floata, b.total*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
				       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
						,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
				from view_vccs b
				left join view_vcc a on a.noa = b.noa
				left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
				outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
				where (a.datea between @t_bdate and @t_edate) and
					  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
					  ((case when a.custno2!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
					  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno) and
					  (b.productno between @t_bproductno and @t_eproductno) and (len(@t_cno)=0 or a.cno=@t_cno)
				union all --無發票系統
				select @coin,'0' gno, '稅' typea, a.noa, CHAR(255) noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
					   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
					   0 mount, 0 weight, 0 price, (case when a.typea!='1' then -1 else 1 end) * tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
					   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
						,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales 
				from view_vcc a
				left join cust c on (case when a.custno2!='' then a.custno2 else a.custno end) = c.noa 
				outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
				where tax > 0 and (taxtype='1' or taxtype='5') and
					  (a.datea between @t_bdate and @t_edate)and
					  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
					  ( (case when isnull(a.custno2,'') !='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
					  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
					  and (len(@t_cno)=0 or a.cno=@t_cno)
				union all --有發票系統
				select @coin,'0' gno, '稅' typea, a.noa, '' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
					   a.custno, '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
					   0 mount, 0 weight, 0 price, a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
					   ,c.salesno,c.sales
				from vcca a left join cust c on a.custno = c.noa
				outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin 
				where tax > 0 and (taxtype='1' or taxtype='5') and ([21]!=3) and
						(a.datea between @t_bdate and @t_edate)and
					  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
					  (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and
					  (isnull(c.salesno,'') between @t_bsalesno and @t_esalesno) and (len(@t_cno)=0 or a.cno=@t_cno)
				order by custno,gno,mon,datea,noa,noq
		end
		else
		begin
			insert into @result
			select @coin,'0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
					   (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
				       b.mount, b.weight, b.price*coin.floata, b.total*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
				       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
						,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
				from view_vccs b
				left join view_vcc a on a.noa = b.noa
				left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
				outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
				where (a.datea between @t_bdate and @t_edate) and a.unpay>0 and
					  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
					  ((case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
					  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno) and
					  (b.productno between @t_bproductno and @t_eproductno) and (len(@t_cno)=0 or a.cno=@t_cno)
				union all --無發票系統
				select @coin,'0' gno, '稅' typea, a.noa, CHAR(255) noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
					   (case when a.custno2!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
					   0 mount, 0 weight, 0 price, (case when a.typea!='1' then -1 else 1 end) *a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
					   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
						,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
				from view_vcc a
				left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) = c.noa
				outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
				where tax > 0 and (a.taxtype='1' or a.taxtype='5') and
					  (a.datea between @t_bdate and @t_edate)and
					  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
					  ( (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno) and
					  ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
					  and (len(@t_cno)=0 or a.cno=@t_cno)
				union all --有發票系統
				select @coin,'0' gno, '稅' typea, a.noa, '' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
					   custno, '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
					   0 mount, 0 weight, 0 price, a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
					   ,c.salesno,c.sales
				from vcca a left join cust c on a.custno = c.noa
				outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin 
				where tax > 0 and (a.taxtype='1' or a.taxtype='5') and ([21]!=3) and
						(a.datea between @t_bdate and @t_edate)and
					  ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) between @t_bmon and @t_emon) and
					  (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and 
					  (isnull(c.salesno,'') between @t_bsalesno and @t_esalesno) and (len(@t_cno)=0 or a.cno=@t_cno)
				order by custno,gno,mon,datea,noa,noq
		end

		fetch next from cursor_table
		into @coin
	
	end
	close cursor_table
	deallocate cursor_table
end

declare @t_coin nvarchar(20)
declare @gno nvarchar(1)
declare @typea nvarchar(4)
declare @noa nvarchar(30)
declare @total decimal(18,0)
declare @mon nvarchar(7)
declare @custno nvarchar(50)
declare @comp nvarchar(MAX)
declare @t_custno nvarchar(50)
declare @t_comp nvarchar(MAX)
declare @t_money decimal(18,0)
declare @t_back decimal(18,0)
declare @t_tax decimal(18,0)
declare @t_total1 decimal(18,0)
declare @t_pay decimal(18,0)
declare @t_unpay decimal(18,0)
declare @t_total2 decimal(18,0)
declare @t_pcount int
set @t_custno = '#zzzz#zzzz'
set @t_coin = '#zzzz#zzzz'
set @t_comp = ''
set @t_money = 0
set @t_back = 0
set @t_tax = 0
set @t_total1 = 0
set @t_pay = 0
set @t_unpay = 0
set @t_total2 = 0
set @t_pcount = 0

--declare cursor_table cursor for
--select coin,gno,typea,custno,comp,mon,total from @result order by coin,custno
--open cursor_table
--fetch next from cursor_table
--into @coin,@gno,@typea,@custno,@comp,@mon,@total
--while(@@FETCH_STATUS <> -1)
--begin
--	if @t_custno != @custno or @t_coin!=@coin
--	begin
--		if @t_custno != '#zzzz#zzzz' and @t_coin!='#zzzz#zzzz'
--		begin
--			set @t_total1 = @t_money - @t_back + @t_tax
--			insert into @result
--			select @t_coin,'1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel,
--			       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total,
--				   @t_money, @t_back, @t_tax, @t_total1
--				   , isnull((select sum(ub.paysale) from umms ub where ub.vccno in (select noa from @result where gno='0' and custno=@t_custno)),0) --單據
--					+isnull((select sum(ub.paysale) from umms ub where (ub.custno+'-'+ub.paymon=ub.vccno 
--					and (ub.paymon between @t_bmon and @t_emon) and (ub.paymon+'/01' between @t_bdate and @t_edate) 
--					and ub.custno=@t_custno)),0) --月結
--					 pay
--				   , 0 unpay, 0 total2, @t_pcount,'',''
--		end
--		set @t_custno = @custno
--		set @t_coin = @coin
--		set @t_comp = @comp
--		set @t_money = case when @typea = '1' then @total else 0 end
--		set @t_back = case when @typea = '2' then @total else 0 end
--		set @t_tax = case when @typea = '稅' then @total else 0 end
--		set @t_pcount = 1
--	end
--	else
--	begin
--		set @t_money = @t_money + case when @typea = '1' then @total else 0 end
--		set @t_back = @t_back + case when @typea = '2' then @total else 0 end
--		set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
--		set @t_pcount = @t_pcount + 1
--	end
--	fetch next from cursor_table
--	into @coin,@gno,@typea,@custno,@comp,@mon,@total
--end
--close cursor_table
--deallocate cursor_table

--if @t_custno != '#zzzz#zzzz' and @t_coin!='#zzzz#zzzz'
--begin
--	set @t_total1 = @t_money - @t_back + @t_tax
--	insert into @result
--	select @t_coin,'1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel,
--			'' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total,
--			@t_money, @t_back, @t_tax, @t_total1
--			, isnull((select sum(ub.paysale) from umms ub where ub.vccno in (select noa from @result where gno='0' and custno=@t_custno)),0) --單據
--			+isnull((select sum(ub.paysale) from umms ub where (ub.custno+'-'+ub.paymon=ub.vccno 
--			and (ub.paymon between @t_bmon and @t_emon) and (ub.paymon+'/01' between @t_bdate and @t_edate) 
--			and ub.custno=@t_custno)),0) --月結
--			 pay
--			, 0 unpay, 0 total2, @t_pcount,'',''
--end

insert @result
select coin,'1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, custno, MAX(comp) comp, '' addr_invo, '' tel, '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total, 
sum(case when typea in ('1','折') then total else 0 end), sum(case when typea = '2' then total else 0 end)
,SUM(case when typea = '稅' then total else 0 end) , 0
, isnull((select sum(ub.paysale) from umms ub where exists (select noa from @result where ub.vccno=noa and gno='0' and custno=a.custno)),0) --單據 
+isnull((select sum(ub.paysale) from umms ub where (ub.custno+'-'+ub.paymon=ub.vccno 
and (ub.paymon between @t_bmon and @t_emon) and (ub.paymon+'/01' between @t_bdate and @t_edate) 
and ub.custno=a.custno)),0) --月結 
pay , 0 unpay, 0 total2, count(*),'',''  from @result a group by custno,coin

update @result set total1=money-back+tax where gno='1'
	
update @result set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

--104/05/07單據插入小計
if(@t_showordetotal='1')
begin
	insert @result
	select coin,'2',CHAR(255),noa,CHAR(255),datea,mon,custno,MAX(comp),MAX(addr_invo),MAX(tel),'','',''
	,null,null,null,SUM(total),null,null
	,isnull((select sum(tax) from view_vcc where noa=a.noa),0)
	+isnull((select sum(cb.tax) from view_vcc ca left join vcca cb on ca.invono=cb.noa where ca.noa=a.noa and (ca.taxtype='1' or ca.taxtype='5') and [21]!=3),0)
	,null,null,null,null,null,MAX(salesno),MAX(saless)
	from @result a where gno='0' and typea!='稅'
	group by coin,gno,noa,datea,mon,custno
end
--已收款
--update a 
--set pay=isnull((select SUM(paysale*coin.floata) from umms ub
--						left join view_vcc va on ub.vccno=va.noa
--						outer apply (select isnull((select top 1 floata from flors where coin=a.coin and va.datea <=edate order by edate desc,noa desc),1) floata) coin
--						where vccno in(select noa from @result where noa!='' and custno=a.custno)),0) --本期單據以沖金額 
--+isnull((select SUM(ub.paysale*coin.floata) from umms ub 
--			left join view_vcc va on ub.vccno=va.noa
--			outer apply (select isnull((select top 1 floata from flors where coin=a.coin and ub.mon <=edate order by edate desc,noa desc),1) floata) coin
--			where charindex(a.custno+'-',ub.vccno)>0 
--			and SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6)+'/01' between @t_bdate and @t_edate 
--			and SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6) between @t_bmon and @t_emon),0) --找出月結客戶與稅的內容 
--from @result a 
--where a.gno='1'

--104/01/31
--update a 
--set pay= 
--isnull((select sum(ub.paysale) from umms ub where ub.vccno=a.noa),0) 
--from @result a 
--where a.gno='0' and noa!=''

--update a 
--set pay= 
--isnull((select sum(pay) from @result where custno=a.custno and gno='0'),0) --單據
--+isnull((select sum(ub.paysale) from umms ub where (ub.custno+'-'+ub.paymon=ub.vccno
--and (ub.paymon between @t_bmon and @t_emon) and (ub.paymon+'/01' between @t_bdate and @t_edate) 
--and ub.custno=a.custno)),0) --月結
--from @result a 
--where a.gno='1' 

---begin 前期---------------------------------------------------------------------------------------------------
--declare @tmp table(
--	coin nvarchar(20),
--	gno nvarchar(1),
--	typea nvarchar(4),
--	noa nvarchar(30),
--	noq nvarchar(10),
--	datea nvarchar(10),
--	mon nvarchar(7),
--	custno nvarchar(50),
--	comp nvarchar(MAX),
--	addr_invo nvarchar(90),
--	tel nvarchar(90),
--	productno nvarchar(MAX),
--	xproduct nvarchar(MAX),
--	unit nvarchar(8),
--	mount decimal(16,2),
--	weight decimal(16,2),
--	price decimal(16,2),
--	total decimal(18,0),
--	money decimal(18,0),
--	back decimal(18,0),
--	tax decimal(18,0),
--	total1 decimal(18,0),
--	pay decimal(18,0),
--	unpay decimal(18,0),
--	total2 decimal(18,0),
--	pcount int,
--	salesno nvarchar(30),
--	saless nvarchar(30)
--	primary key (coin,custno,gno,mon,datea,noa,noq)
--)

--insert into @tmp
--	select @t_xcoin,'0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
--		    (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
--	       b.mount, b.weight, b.price*coin.floata, b.total*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
--	       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
--			,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
--	from view_vccs b	left join view_vcc a on a.noa = b.noa
--	left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)  = c.noa
--	outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
--	where ((a.datea < @t_bdate ) or ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) < @t_bmon ))
--		  and ( (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno)
--		  and ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
--		  and (b.productno between @t_bproductno and @t_eproductno)
--	union all
--	select @t_xcoin,'0' gno, '稅' typea, a.noa, CHAR(255) noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
--		    (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
--		   0 mount, 0 weight, 0 price, (case when a.typea!='1' then -1 else 1 end) *a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
--		   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
--			,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
--	from view_vcc a left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)  = c.noa
--	outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
--	where tax > 0 and (taxtype='1' or taxtype='5')
--		  and ((a.datea < @t_bdate) or ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) < @t_bmon))
--		  and ((case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno)
--		  and ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
--	union all
--	select @t_xcoin,'0' gno, '稅' typea, a.noa, '' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
--		   custno, '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
--		   0 mount, 0 weight, 0 price, a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
--			,c.salesno,c.sales
--	from vcca a left join cust c on a.custno = c.noa
--	outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and a.datea <=edate order by edate desc,noa desc),1) floata) coin 
--	where tax > 0 and (a.taxtype='1' or a.taxtype='5') and ([21]!=3)
--		and ((a.datea < @t_bdate) or ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) < @t_bmon ))
--		and  (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and
--		(isnull(c.salesno,'') between @t_bsalesno and @t_esalesno)
--	order by custno,gno,mon,datea,noa,noq

--if(@t_xcoin='ALL')
--begin
--	declare cursor_table cursor for
--	select coin from flors group by coin
--	open cursor_table
--	fetch next from cursor_table
--	into @coin
--	while(@@FETCH_STATUS <> -1)
--	begin
		
--		insert into @tmp
--		select @coin,'0' gno, a.typea, a.noa noa, b.noq noq, a.datea datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) mon,
--			    (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) custno, isnull(c.comp,''), isnull(c.addr_invo,''), isnull(c.tel,''), b.productno, b.product, b.unit,
--		       b.mount, b.weight, b.price*coin.floata, b.total*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
--		       ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
--				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
--		from view_vccs b	left join view_vcc a on a.noa = b.noa
--		left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)  = c.noa
--		outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
--		where ((a.datea < @t_bdate ) or ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) < @t_bmon ))
--			  and ( (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno)
--			  and ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
--			  and (b.productno between @t_bproductno and @t_eproductno)
--		union all
--		select @coin,'0' gno, '稅' typea, a.noa, CHAR(255) noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
--			    (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end), '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
--			   0 mount, 0 weight, 0 price, (case when a.typea!='1' then -1 else 1 end) *a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
--			   ,(case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) salesno
--				,(case when isnull(a.salesno2,'')!='' then a.sales2 when isnull(a.salesno,'')!='' then a.sales else c.sales end)sales
--		from view_vcc a left join cust c on  (case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end)  = c.noa
--		outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin
--		where tax > 0 and (taxtype='1' or taxtype='5')
--			  and ((a.datea < @t_bdate) or ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) < @t_bmon))
--			  and ((case when isnull(a.custno2,'')!='' then a.custno2 else a.custno end) between @t_bcustno and @t_ecustno)
--			  and ((case when isnull(a.salesno2,'')!='' then a.salesno2 when isnull(a.salesno,'')!='' then a.salesno else isnull(c.salesno,'') end) between @t_bsalesno and @t_esalesno)
--		union all
--		select @coin,'0' gno, '稅' typea, a.noa, '' noq, a.datea, (case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end),
--			   custno, '' comp, '' addr_invo, '' tel, '' productno, '稅額' product, '' unit,
--			   0 mount, 0 weight, 0 price, a.tax*coin.floata, 0 money, 0 back, 0 tax, 0 total1, 0 pay, 0 unpay, 0 total2, 0 pcount
--				,c.salesno,c.sales
--		from vcca a left join cust c on a.custno = c.noa
--		outer apply (select isnull((select top 1 floata from flors where coin=@coin and a.datea <=edate order by edate desc,noa desc),1) floata) coin 
--		where tax > 0 and (a.taxtype='1' or a.taxtype='5') and ([21]!=3)
--			and ((a.datea < @t_bdate) or ((case when isnull(a.mon,'')='' then left(a.datea,6) else a.mon end) < @t_bmon ))
--			and  (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and
--			(isnull(c.salesno,'') between @t_bsalesno and @t_esalesno)
--		order by custno,gno,mon,datea,noa,noq
	
--		fetch next from cursor_table
--		into @coin
	
--	end
--	close cursor_table
--	deallocate cursor_table
--end


--set @t_coin = '#zzzz#zzzz'
--set @t_custno = '#zzzz#zzzz'
--set @t_comp = ''
--set @t_money = 0
--set @t_back = 0
--set @t_tax = 0
--set @t_total1 = 0
--set @t_pay = 0
--set @t_unpay = 0
--set @t_total2 = 0
--set @t_pcount = 0
--declare @salesno nvarchar(30) =''
--declare @sales nvarchar(30) =''

--declare cursor_table cursor for
--	select coin,gno,typea,custno,comp,mon,total,salesno,saless from @tmp order by coin,custno
--open cursor_table
--fetch next from cursor_table
--into @coin,@gno,@typea,@custno,@comp,@mon,@total,@salesno,@sales
--while(@@FETCH_STATUS <> -1)
--begin
--	if @t_custno != @custno or @t_coin !=@coin
--	begin
--		if @t_custno != '#zzzz#zzzz' and @t_coin!='#zzzz#zzzz'
--		begin
--			set @t_total1 = @t_money - @t_back + @t_tax
--			insert into @tmp
--			select @t_coin,'1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel,
--			       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total,
--				   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,@salesno,@sales
--		end
--		set @t_coin = @coin
--		set @t_custno = @custno
--		set @t_comp = @comp
--		set @t_money = case when @typea = '1' then @total else 0 end
--		set @t_back = case when @typea = '2' then @total else 0 end
--		set @t_tax = case when @typea = '稅' then @total else 0 end
--		set @t_pcount = 1
--	end
--	else
--	begin
--		set @t_money = @t_money + case when @typea = '1' then @total else 0 end
--		set @t_back = @t_back + case when @typea = '2' then @total else 0 end
--		set @t_tax = @t_tax + case when @typea = '稅' then @total else 0 end
--		set @t_pcount = @t_pcount + 1
--		end
--	fetch next from cursor_table
--	into @coin,@gno,@typea,@custno,@comp,@mon,@total,@salesno,@sales
--end
--close cursor_table
--deallocate cursor_table

--if @t_custno != '#zzzz#zzzz' and @t_coin!='#zzzz#zzzz'
--begin
--	set @t_total1 = @t_money - @t_back + @t_tax
--	insert into @tmp
--	select @t_coin,'1' gno, '' typea, '' noa, '' noq, '' datea, '' mon, @t_custno, @t_comp comp, '' addr_invo, '' tel,
--		       '' productno, '' product, '' unit, 0 mount, 0 weight, 0 price, 0 total,
--			   @t_money, @t_back, @t_tax, @t_total1, 0 pay, 0 unpay, 0 total2, @t_pcount,@salesno,@sales
--end

--update @tmp set typea = (case typea when '1' then '出' else '退' end) where typea ='1' or typea = '2'

----已收款
--update a
--	set pay=isnull((select SUM(paysale*coin.floata) from umms ub left join view_vcc va on ub.vccno=va.noa
--	outer apply (select isnull((select top 1 floata from flors where coin=a.coin and va.datea <=edate order by edate desc,noa desc),1) floata) coin
--	where vccno in(select noa from @tmp where noa!='' and custno=a.custno)),0) --本期單據以沖金額
--	+isnull((select SUM(ub.paysale*coin.floata) from umms ub left join view_vcc va on ub.vccno=va.noa
--	outer apply (select isnull((select top 1 floata from flors where coin=a.coin and ub.mon <=edate order by edate desc,noa desc),1) floata) coin
--				where charindex(a.custno+'-',ub.vccno)>0
--				and (SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6)+'/01' < @t_bdate
--				or SUBSTRING(vccno,CHARINDEX('-',vccno)+1,6) < @t_bmon) ),0) --找出月結客戶與稅的內容
--from @tmp a where a.gno='1'

declare @tmp table( 
	coin nvarchar(20), 
	gno nvarchar(1), 
	custno nvarchar(50), 
	total decimal(18,0), 
	salesno nvarchar(30)
) 

insert into @tmp (coin,gno,custno,salesno,total)
select @t_xcoin,'1',custno,salesno,SUM(money) from (
	--trd
	--select aa.custno,bb.salesno,SUM(isnull(unpay,0)) money from view_trd aa left join cust bb on aa.custno=bb.noa where (case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end) < @t_bsmon
	--and len(@t_paytype)=0
	--group by  aa.custno,bb.salesno
	--union all
	--vcc
	select (case when aa.custno2!='' then aa.custno2 else aa.custno end) custno,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end) salesno
	--,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,6)<@t_bsmon and left(vccno,len(vccno)-7)=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0) money
	,SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay*coin.floata,0))
	-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ub.custno+'-'+ub.paymon=ub.vccno and (ub.paymon<@t_bmon or ub.paymon+'/01'<@t_bdate) and ub.custno=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0)*coin.floata money 
	from view_vcc aa left join cust bb on aa.custno=bb.noa 
	outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and aa.datea <=edate order by edate desc,noa desc),1) floata) coin 
	where ((case when len(aa.mon)=0 then left(aa.datea,6) else aa.mon end) < @t_bmon and aa.datea <@t_bdate) and (left(isnull(kind,''),4)!='健勞勞退')
	and (len(@t_cno)=0 or aa.cno=@t_cno)
	group by (case when aa.custno2!='' then aa.custno2 else aa.custno end) ,(case when aa.salesno2!='' then aa.salesno2 when aa.salesno !='' then aa.salesno else bb.salesno end),coin.floata
	having SUM(isnull((case when aa.typea='1' then 1 else -1 end)*unpay*coin.floata,0))	-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ub.custno+'-'+ub.paymon=ub.vccno and (ub.paymon<@t_bmon or ub.paymon+'/01'<@t_bdate) and ub.custno=(case when aa.custno2!='' then aa.custno2 else aa.custno end)),0)*coin.floata!=0
	--vcca
	union all
	select  ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end) salesno
	--,SUM(isnull(ca.tax,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where len(vccno)>8 and right(vccno,4)='-TAX' and left(right(vccno,10),6)<@t_bsmon and left(vccno,len(vccno)-11)=ca.custno),0)
	,SUM(isnull(ca.tax*coin.floata,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ca.noa=ub.vccno and (ub.paymon<@t_bmon or ub.paymon+'/01'<@t_bdate) and ub.custno=ca.custno),0) *coin.floata
	from vcca ca left join view_vcc cb on ca.noa=cb.invono left join cust cc on ca.custno=cc.noa
	outer apply (select isnull((select top 1 floata from flors where coin=@t_xcoin and ca.datea <=edate order by edate desc,noa desc),1) floata) coin 
	where ((case when ca.mon!='' then ca.mon else LEFT(ca.datea,6) end) < @t_bmon and ca.datea <@t_bdate) and ([21]!=3)
	and (ca.taxtype='1' or ca.taxtype='5') and (len(@t_cno)=0 or ca.cno=@t_cno)
	group by ca.custno,(case when cb.salesno2!='' then cb.salesno2 when cb.salesno !='' then cb.salesno else cc.salesno end),ca.noa,coin.floata
	having SUM(isnull(ca.tax*coin.floata,0))-isnull((select sum(ub.paysale) from umms ub left join umm ua on ub.noa=ua.noa where ca.noa=ub.vccno and (ub.paymon<@t_bmon or ub.paymon+'/01'<@t_bdate) and ub.custno=ca.custno),0)*coin.floata !=0
	--union all
	--cara
	--select ca.carownerno,ca.sssno,outmoney-inmoney from cara ca left join caras cb on ca.noa=cb.noa where ca.mon=@t_bsmon and cb.caritemno='001'
	--and len(@t_paytype)=0
)tmp --where (custno between @t_bcustno and @t_ecustno ) and (salesno between @t_bsalesno and @t_esalesno) 
group by custno,salesno

delete @tmp where not((custno between @t_bcustno and @t_ecustno ) and (salesno between @t_bsalesno and @t_esalesno)) 

-----end 前期----------------------------------------------------------------------------------

--update a
--	set unpay=isnull((select total1-pay from @tmp where custno=a.custno and coin=a.coin and gno='1'),0)
--from @result a where a.gno='1'

--insert into @result (coin,gno,noa,noq,datea,mon,custno,comp,salesno,saless,total1,pay,unpay)
--select coin,gno,noa,noq,datea,mon,custno,comp,salesno,saless,0,0,total1-pay+unpay from @tmp
--where custno not in (select custno from @result) and gno='1' and (total1-pay+unpay)!=0

update a 
set unpay=isnull((select sum(total) from @tmp where custno=a.custno and coin=a.coin and gno='1'),0) 
from @result a where a.gno='1' 

--insert into @result (coin,gno,noa,noq,datea,mon,custno,comp,salesno,saless,total1,pay,unpay) 
--select coin,gno,'','','','',a.custno,b.comp,a.salesno,c.namea,0,0,total from @tmp a 
--left join cust b on a.custno=b.noa left join sss c on a.salesno=c.noa
--where custno not in (select custno from @result) and gno='1' and total!=0 

insert into @result (coin,gno,noa,noq,datea,mon,custno,comp,salesno,saless,total1,pay,unpay) 
select coin,gno,'','','','',a.custno,b.comp,'','',0,0,sum(total) from @tmp a 
left join cust b on a.custno=b.noa 
where custno not in (select custno from @result) and gno='1' and total!=0 
group by coin,gno,a.custno,b.comp

update @result
set salesno=(select top 1 (case when salesno2!='' then salesno2 else salesno end) from view_vcc order by datea desc )
,saless=(select top 1 (case when salesno2!='' then sales2 else sales end) from view_vcc order by datea desc )
where salesno=''

update @result
	set total2=total1+unpay-pay
where gno='1'

--當本期區間內沒有未收就不顯示
if(@t_showunpay='1')
delete @result where custno in (select custno from @result where gno='1' and total2=0)

if(@t_xcoin='ALL')
begin
	update @result set coin='' where coin=@t_xcoin
	update @tmp set coin='' where coin=@t_xcoin
end

select
	gno,typea,noa,noq,datea,mon,custno,comp,addr_invo,tel,productno,replace(xproduct,'~#$',char(39)) xproduct,unit
	,(select top 1 saless from @result where custno=a.custno and saless!='' order by datea desc)saless
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),0,30)) mount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,weight),1)),0,30)) weight
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,price),1)),0,30)) price
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total),1)),(case when coin!='' then 0 else 4 end),30)) total
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,money),1)),(case when coin!='' then 0 else 4 end),30)) money
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,back),1)),(case when coin!='' then 0 else 4 end),30)) back
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,tax),1)),(case when coin!='' then 0 else 4 end),30)) tax
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total1),1)),(case when coin!='' then 0 else 4 end),30)) total1
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,pay),1)),(case when coin!='' then 0 else 4 end),30)) pay
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,unpay),1)),(case when coin!='' then 0 else 4 end),30)) unpay
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,total2),1)),(case when coin!='' then 0 else 4 end),30)) total2
	,pcount,case when coin!='' then '_'+coin else '' end coin 
from @result a order by custno,coin,case when gno='2' then '0' else gno end,mon,datea,noa,noq;
--**************************************************************************************************